<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>astroquery.alma.core &#8212; astroquery v0.4.8.dev10177</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/bootstrap-astropy.css?v=9d21690f" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=fd3f3429" />
    <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
    
    <script src="../../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../../../_static/documentation_options.js?v=51006566"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../_static/copybutton.js"></script>
    <link rel="icon" href="../../../_static/astropy_logo.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../index.html"><span id="logotext1">astro</span><span id="logotext2">query</span><span id="logotext3">:docs</span></a>
  <ul>
    
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../index.html">astroquery v0.4.8.dev10177</a>
	 &#187;
      </li>
      <li><a href="../../index.html" >Module code</a> &#187;</li>
      <li><a href="../alma.html" accesskey="U">astroquery.alma</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for astroquery.alma.core</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>

<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">keyring</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">importlib.resources</span> <span class="k">as</span> <span class="nn">importlib_resources</span>

<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">import</span> <span class="nn">pyvo</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urljoin</span>

<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">vstack</span>
<span class="kn">from</span> <span class="nn">astroquery</span> <span class="kn">import</span> <span class="n">log</span>
<span class="kn">from</span> <span class="nn">astropy.utils.console</span> <span class="kn">import</span> <span class="n">ProgressBar</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">astropy.time</span> <span class="kn">import</span> <span class="n">Time</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span>

<span class="kn">from</span> <span class="nn">pyvo.dal.sia2</span> <span class="kn">import</span> <span class="n">SIA2_PARAMETERS_DESC</span><span class="p">,</span> <span class="n">SIA2Service</span>

<span class="kn">from</span> <span class="nn">..exceptions</span> <span class="kn">import</span> <span class="n">LoginError</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">commons</span>
<span class="kn">from</span> <span class="nn">..utils.process_asyncs</span> <span class="kn">import</span> <span class="n">async_to_sync</span>
<span class="kn">from</span> <span class="nn">..query</span> <span class="kn">import</span> <span class="n">BaseQuery</span><span class="p">,</span> <span class="n">QueryWithLogin</span><span class="p">,</span> <span class="n">BaseVOQuery</span>
<span class="kn">from</span> <span class="nn">.tapsql</span> <span class="kn">import</span> <span class="p">(</span><span class="n">_gen_pos_sql</span><span class="p">,</span> <span class="n">_gen_str_sql</span><span class="p">,</span> <span class="n">_gen_numeric_sql</span><span class="p">,</span>
                     <span class="n">_gen_band_list_sql</span><span class="p">,</span> <span class="n">_gen_datetime_sql</span><span class="p">,</span> <span class="n">_gen_pol_sql</span><span class="p">,</span> <span class="n">_gen_pub_sql</span><span class="p">,</span>
                     <span class="n">_gen_science_sql</span><span class="p">,</span> <span class="n">ALMA_DATE_FORMAT</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">conf</span><span class="p">,</span> <span class="n">auth_urls</span>
<span class="kn">from</span> <span class="nn">astroquery.exceptions</span> <span class="kn">import</span> <span class="n">CorruptDataWarning</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;AlmaClass&#39;</span><span class="p">,</span> <span class="s1">&#39;ALMA_BANDS&#39;</span><span class="p">,</span> <span class="s1">&#39;get_enhanced_table&#39;</span><span class="p">}</span>

<span class="n">__doctest_skip__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AlmaClass.*&#39;</span><span class="p">]</span>


<span class="c1"># Map from ALMA ObsCore result to ALMA original query result</span>
<span class="c1"># The map is provided in order to preserve the name of the columns in the</span>
<span class="c1"># original ALMA query original results and make it backwards compatible</span>
<span class="c1"># key - current column, value - original column name</span>
<span class="n">_OBSCORE_TO_ALMARESULT</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;proposal_id&#39;</span><span class="p">:</span> <span class="s1">&#39;Project code&#39;</span><span class="p">,</span>
    <span class="s1">&#39;target_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Source name&#39;</span><span class="p">,</span>
    <span class="s1">&#39;s_ra&#39;</span><span class="p">:</span> <span class="s1">&#39;RA&#39;</span><span class="p">,</span>
    <span class="s1">&#39;s_dec&#39;</span><span class="p">:</span> <span class="s1">&#39;Dec&#39;</span><span class="p">,</span>
    <span class="s1">&#39;gal_longitude&#39;</span><span class="p">:</span> <span class="s1">&#39;Galactic longitude&#39;</span><span class="p">,</span>
    <span class="s1">&#39;gal_latitude&#39;</span><span class="p">:</span> <span class="s1">&#39;Galactic latitude&#39;</span><span class="p">,</span>
    <span class="s1">&#39;band_list&#39;</span><span class="p">:</span> <span class="s1">&#39;Band&#39;</span><span class="p">,</span>
    <span class="s1">&#39;s_region&#39;</span><span class="p">:</span> <span class="s1">&#39;Footprint&#39;</span><span class="p">,</span>
    <span class="s1">&#39;em_resolution&#39;</span><span class="p">:</span> <span class="s1">&#39;Frequency resolution (m)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;spectral_resolution&#39;</span><span class="p">:</span> <span class="s1">&#39;Frequency resolution (Hz)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;antenna_arrays&#39;</span><span class="p">:</span> <span class="s1">&#39;Array&#39;</span><span class="p">,</span>
    <span class="s1">&#39;is_mosaic&#39;</span><span class="p">:</span> <span class="s1">&#39;Mosaic&#39;</span><span class="p">,</span>
    <span class="s1">&#39;t_exptime&#39;</span><span class="p">:</span> <span class="s1">&#39;Integration&#39;</span><span class="p">,</span>
    <span class="s1">&#39;obs_release_date&#39;</span><span class="p">:</span> <span class="s1">&#39;Release date&#39;</span><span class="p">,</span>
    <span class="s1">&#39;frequency_support&#39;</span><span class="p">:</span> <span class="s1">&#39;Frequency support&#39;</span><span class="p">,</span>
    <span class="s1">&#39;velocity_resolution&#39;</span><span class="p">:</span> <span class="s1">&#39;Velocity resolution&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pol_states&#39;</span><span class="p">:</span> <span class="s1">&#39;Pol products&#39;</span><span class="p">,</span>
    <span class="s1">&#39;t_min&#39;</span><span class="p">:</span> <span class="s1">&#39;Observation date&#39;</span><span class="p">,</span>
    <span class="s1">&#39;obs_creator_name&#39;</span><span class="p">:</span> <span class="s1">&#39;PI name&#39;</span><span class="p">,</span>
    <span class="s1">&#39;schedblock_name&#39;</span><span class="p">:</span> <span class="s1">&#39;SB name&#39;</span><span class="p">,</span>
    <span class="s1">&#39;proposal_authors&#39;</span><span class="p">:</span> <span class="s1">&#39;Proposal authors&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sensitivity_10kms&#39;</span><span class="p">:</span> <span class="s1">&#39;Line sensitivity (10 km/s)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cont_sensitivity_bandwidth&#39;</span><span class="p">:</span> <span class="s1">&#39;Continuum sensitivity&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pwv&#39;</span><span class="p">:</span> <span class="s1">&#39;PWV&#39;</span><span class="p">,</span>
    <span class="s1">&#39;group_ous_uid&#39;</span><span class="p">:</span> <span class="s1">&#39;Group ous id&#39;</span><span class="p">,</span>
    <span class="s1">&#39;member_ous_uid&#39;</span><span class="p">:</span> <span class="s1">&#39;Member ous id&#39;</span><span class="p">,</span>
    <span class="s1">&#39;asdm_uid&#39;</span><span class="p">:</span> <span class="s1">&#39;Asdm uid&#39;</span><span class="p">,</span>
    <span class="s1">&#39;obs_title&#39;</span><span class="p">:</span> <span class="s1">&#39;Project title&#39;</span><span class="p">,</span>
    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;Project type&#39;</span><span class="p">,</span>
    <span class="s1">&#39;scan_intent&#39;</span><span class="p">:</span> <span class="s1">&#39;Scan intent&#39;</span><span class="p">,</span>
    <span class="s1">&#39;s_fov&#39;</span><span class="p">:</span> <span class="s1">&#39;Field of view&#39;</span><span class="p">,</span>
    <span class="s1">&#39;spatial_scale_max&#39;</span><span class="p">:</span> <span class="s1">&#39;Largest angular scale&#39;</span><span class="p">,</span>
    <span class="s1">&#39;qa2_passed&#39;</span><span class="p">:</span> <span class="s1">&#39;QA2 Status&#39;</span><span class="p">,</span>
    <span class="c1">#  TODO	COUNT</span>
    <span class="s1">&#39;science_keyword&#39;</span><span class="p">:</span> <span class="s1">&#39;Science keyword&#39;</span><span class="p">,</span>
    <span class="s1">&#39;scientific_category&#39;</span><span class="p">:</span> <span class="s1">&#39;Scientific category&#39;</span>
<span class="p">}</span>


<span class="n">ALMA_BANDS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;3&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">84</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GHz</span><span class="p">,</span> <span class="mi">116</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GHz</span><span class="p">),</span>
    <span class="s1">&#39;4&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">125</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GHz</span><span class="p">,</span> <span class="mi">163</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GHz</span><span class="p">),</span>
    <span class="s1">&#39;5&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">163</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GHz</span><span class="p">,</span> <span class="mi">211</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GHz</span><span class="p">),</span>
    <span class="s1">&#39;6&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">211</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GHz</span><span class="p">,</span> <span class="mi">275</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GHz</span><span class="p">),</span>
    <span class="s1">&#39;7&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">275</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GHz</span><span class="p">,</span> <span class="mi">373</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GHz</span><span class="p">),</span>
    <span class="s1">&#39;8&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">385</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GHz</span><span class="p">,</span> <span class="mi">500</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GHz</span><span class="p">),</span>
    <span class="s1">&#39;9&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">602</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GHz</span><span class="p">,</span> <span class="mi">720</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GHz</span><span class="p">),</span>
    <span class="s1">&#39;10&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">787</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GHz</span><span class="p">,</span> <span class="mi">950</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GHz</span><span class="p">)</span>
<span class="p">}</span>


<span class="n">ALMA_FORM_KEYS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Position&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;Source name (astropy Resolver)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;source_name_resolver&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;SkyCoord.from_name&#39;</span><span class="p">,</span> <span class="n">_gen_pos_sql</span><span class="p">],</span>
        <span class="s1">&#39;Source name (ALMA)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;source_name_alma&#39;</span><span class="p">,</span> <span class="s1">&#39;target_name&#39;</span><span class="p">,</span> <span class="n">_gen_str_sql</span><span class="p">],</span>
        <span class="s1">&#39;RA Dec (Sexagesimal)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;ra_dec&#39;</span><span class="p">,</span> <span class="s1">&#39;s_ra, s_dec&#39;</span><span class="p">,</span> <span class="n">_gen_pos_sql</span><span class="p">],</span>
        <span class="s1">&#39;Galactic (Degrees)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;galactic&#39;</span><span class="p">,</span> <span class="s1">&#39;gal_longitude, gal_latitude&#39;</span><span class="p">,</span>
                               <span class="n">_gen_pos_sql</span><span class="p">],</span>
        <span class="s1">&#39;Angular resolution (arcsec)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;spatial_resolution&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;spatial_resolution&#39;</span><span class="p">,</span> <span class="n">_gen_numeric_sql</span><span class="p">],</span>
        <span class="s1">&#39;Largest angular scale (arcsec)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;spatial_scale_max&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;spatial_scale_max&#39;</span><span class="p">,</span> <span class="n">_gen_numeric_sql</span><span class="p">],</span>
        <span class="s1">&#39;Field of view (arcsec)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;fov&#39;</span><span class="p">,</span> <span class="s1">&#39;s_fov&#39;</span><span class="p">,</span> <span class="n">_gen_numeric_sql</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s1">&#39;Energy&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;Frequency (GHz)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">,</span> <span class="s1">&#39;frequency&#39;</span><span class="p">,</span> <span class="n">_gen_numeric_sql</span><span class="p">],</span>
        <span class="s1">&#39;Bandwidth (Hz)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;bandwidth&#39;</span><span class="p">,</span> <span class="s1">&#39;bandwidth&#39;</span><span class="p">,</span> <span class="n">_gen_numeric_sql</span><span class="p">],</span>
        <span class="s1">&#39;Spectral resolution (KHz)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;spectral_resolution&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;spectral_resolution&#39;</span><span class="p">,</span> <span class="n">_gen_numeric_sql</span><span class="p">],</span>
        <span class="s1">&#39;Spectral resolution (m)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;em_resolution&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;em_resolution&#39;</span><span class="p">,</span> <span class="n">_gen_numeric_sql</span><span class="p">],</span>
        <span class="s1">&#39;Band&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;band_list&#39;</span><span class="p">,</span> <span class="s1">&#39;band_list&#39;</span><span class="p">,</span> <span class="n">_gen_band_list_sql</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s1">&#39;Time&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;Observation date&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;start_date&#39;</span><span class="p">,</span> <span class="s1">&#39;t_min&#39;</span><span class="p">,</span> <span class="n">_gen_datetime_sql</span><span class="p">],</span>
        <span class="s1">&#39;Integration time (s)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;integration_time&#39;</span><span class="p">,</span> <span class="s1">&#39;t_exptime&#39;</span><span class="p">,</span>
                                 <span class="n">_gen_numeric_sql</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s1">&#39;Polarization&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;Polarisation type (Single, Dual, Full)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;polarisation_type&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;pol_states&#39;</span><span class="p">,</span> <span class="n">_gen_pol_sql</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s1">&#39;Observation&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;Line sensitivity (10 km/s) (mJy/beam)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;line_sensitivity&#39;</span><span class="p">,</span>
                                                  <span class="s1">&#39;sensitivity_10kms&#39;</span><span class="p">,</span>
                                                  <span class="n">_gen_numeric_sql</span><span class="p">],</span>
        <span class="s1">&#39;Continuum sensitivity (mJy/beam)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;continuum_sensitivity&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;cont_sensitivity_bandwidth&#39;</span><span class="p">,</span>
                                             <span class="n">_gen_numeric_sql</span><span class="p">],</span>
        <span class="s1">&#39;Water vapour (mm)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;water_vapour&#39;</span><span class="p">,</span> <span class="s1">&#39;pvw&#39;</span><span class="p">,</span> <span class="n">_gen_numeric_sql</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s1">&#39;Project&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;Project code&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;project_code&#39;</span><span class="p">,</span> <span class="s1">&#39;proposal_id&#39;</span><span class="p">,</span> <span class="n">_gen_str_sql</span><span class="p">],</span>
        <span class="s1">&#39;Project title&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;project_title&#39;</span><span class="p">,</span> <span class="s1">&#39;obs_title&#39;</span><span class="p">,</span> <span class="n">_gen_str_sql</span><span class="p">],</span>
        <span class="s1">&#39;PI name&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;pi_name&#39;</span><span class="p">,</span> <span class="s1">&#39;pi_name&#39;</span><span class="p">,</span> <span class="n">_gen_str_sql</span><span class="p">],</span>
        <span class="s1">&#39;Proposal authors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;proposal_authors&#39;</span><span class="p">,</span> <span class="s1">&#39;proposal_authors&#39;</span><span class="p">,</span> <span class="n">_gen_str_sql</span><span class="p">],</span>
        <span class="s1">&#39;Project abstract&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;project_abstract&#39;</span><span class="p">,</span> <span class="s1">&#39;proposal_abstract&#39;</span><span class="p">,</span> <span class="n">_gen_str_sql</span><span class="p">],</span>
        <span class="s1">&#39;Publication count&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;publication_count&#39;</span><span class="p">,</span> <span class="s1">&#39;NA&#39;</span><span class="p">,</span> <span class="n">_gen_str_sql</span><span class="p">],</span>
        <span class="s1">&#39;Science keyword&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;science_keyword&#39;</span><span class="p">,</span> <span class="s1">&#39;science_keyword&#39;</span><span class="p">,</span> <span class="n">_gen_str_sql</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s1">&#39;Publication&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;Bibcode&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;bibcode&#39;</span><span class="p">,</span> <span class="s1">&#39;bib_reference&#39;</span><span class="p">,</span> <span class="n">_gen_str_sql</span><span class="p">],</span>
        <span class="s1">&#39;Title&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;pub_title&#39;</span><span class="p">,</span> <span class="s1">&#39;pub_title&#39;</span><span class="p">,</span> <span class="n">_gen_str_sql</span><span class="p">],</span>
        <span class="s1">&#39;First author&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;first_author&#39;</span><span class="p">,</span> <span class="s1">&#39;first_author&#39;</span><span class="p">,</span> <span class="n">_gen_str_sql</span><span class="p">],</span>
        <span class="s1">&#39;Authors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;authors&#39;</span><span class="p">,</span> <span class="s1">&#39;authors&#39;</span><span class="p">,</span> <span class="n">_gen_str_sql</span><span class="p">],</span>
        <span class="s1">&#39;Abstract&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;pub_abstract&#39;</span><span class="p">,</span> <span class="s1">&#39;pub_abstract&#39;</span><span class="p">,</span> <span class="n">_gen_str_sql</span><span class="p">],</span>
        <span class="s1">&#39;Year&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;publication_year&#39;</span><span class="p">,</span> <span class="s1">&#39;pub_year&#39;</span><span class="p">,</span> <span class="n">_gen_numeric_sql</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s1">&#39;Options&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;Public data only&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;public_data&#39;</span><span class="p">,</span> <span class="s1">&#39;data_rights&#39;</span><span class="p">,</span> <span class="n">_gen_pub_sql</span><span class="p">],</span>
        <span class="s1">&#39;Science observations only&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;science_observation&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;science_observation&#39;</span><span class="p">,</span> <span class="n">_gen_science_sql</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="c1"># used to lookup the TAP service on an ARC</span>
<span class="n">TAP_SERVICE_PATH</span> <span class="o">=</span> <span class="s1">&#39;tap&#39;</span>

<span class="c1"># standard ID URI to look for when expanding TAR files</span>
<span class="n">DATALINK_STANDARD_ID</span> <span class="o">=</span> <span class="s1">&#39;ivo://ivoa.net/std/DataLink#links-1.0&#39;</span>

<span class="c1"># used to lookup the DataLink service on an ARC</span>
<span class="n">DATALINK_SERVICE_PATH</span> <span class="o">=</span> <span class="s1">&#39;datalink/sync&#39;</span>

<span class="c1"># used to lookup the SIA service on an ARC</span>
<span class="n">SIA_SERVICE_PATH</span> <span class="o">=</span> <span class="s1">&#39;sia2&#39;</span>


<span class="k">def</span> <span class="nf">_gen_sql</span><span class="p">(</span><span class="n">payload</span><span class="p">):</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;select * from ivoa.obscore&#39;</span>
    <span class="n">where</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">unused_payload</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">payload</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">attrib_category</span> <span class="ow">in</span> <span class="n">ALMA_FORM_KEYS</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">attrib</span> <span class="ow">in</span> <span class="n">attrib_category</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">attrib</span><span class="p">:</span>
                        <span class="c1"># use the value and the second entry in attrib which</span>
                        <span class="c1"># is the new name of the column</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="n">constraint</span><span class="p">]</span>
                        <span class="n">attrib_where</span> <span class="o">=</span> <span class="n">attrib</span><span class="p">[</span><span class="mi">2</span><span class="p">](</span><span class="n">attrib</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">val</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">attrib_where</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">where</span><span class="p">:</span>
                                <span class="n">where</span> <span class="o">+=</span> <span class="s1">&#39; AND &#39;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">where</span> <span class="o">=</span> <span class="s1">&#39; WHERE &#39;</span>
                            <span class="n">where</span> <span class="o">+=</span> <span class="n">attrib_where</span>

                        <span class="c1"># Delete this key to see what&#39;s left over afterward</span>
                        <span class="c1">#</span>
                        <span class="c1"># Use pop to avoid the slight possibility of trying to remove</span>
                        <span class="c1"># an already removed key</span>
                        <span class="n">unused_payload</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">constraint</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">unused_payload</span><span class="p">:</span>
        <span class="c1"># Left over (unused) constraints passed.  Let the user know.</span>
        <span class="n">remaining</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1"> -&gt; </span><span class="si">{</span><span class="n">unused_payload</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">unused_payload</span><span class="p">]</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unsupported arguments were passed:</span><span class="se">\n</span><span class="si">{</span><span class="n">remaining</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sql</span> <span class="o">+</span> <span class="n">where</span>


<div class="viewcode-block" id="get_enhanced_table">
<a class="viewcode-back" href="../../../api/astroquery.alma.get_enhanced_table.html#astroquery.alma.get_enhanced_table">[docs]</a>
<span class="k">def</span> <span class="nf">get_enhanced_table</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns an enhanced table with quantities instead of values and regions for footprints.</span>
<span class="sd">    Note that this function is dependent on the ``astropy`` - affiliated ``regions`` package.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">regions</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Could not import astropy-regions, which is a requirement for get_enhanced_table function in alma.&quot;</span>
            <span class="s2">&quot;Please refer to https://astropy-regions.readthedocs.io/en/latest/installation.html for how to install it.&quot;</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">_parse_stcs_string</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
        <span class="n">csys</span> <span class="o">=</span> <span class="s1">&#39;icrs&#39;</span>

        <span class="k">def</span> <span class="nf">_get_region</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;polygon&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">csys</span> <span class="o">==</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">points</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
                    <span class="p">[(</span><span class="nb">float</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="n">ii</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
                     <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">),</span> <span class="mi">2</span><span class="p">)],</span> <span class="n">frame</span><span class="o">=</span><span class="n">csys</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">regions</span><span class="o">.</span><span class="n">PolygonSkyRegion</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;circle&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">csys</span> <span class="o">==</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">return</span> <span class="n">regions</span><span class="o">.</span><span class="n">CircleSkyRegion</span><span class="p">(</span>
                    <span class="n">SkyCoord</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span>
                    <span class="nb">float</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unrecognized shape: &quot;</span> <span class="o">+</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">s_region</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">s_region</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;union&#39;</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># skip the union operator</span>
            <span class="n">input_regions</span> <span class="o">=</span> <span class="n">s_region</span><span class="p">[</span><span class="n">s_region</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">s_region</span><span class="o">.</span><span class="n">rindex</span><span class="p">(</span>
                <span class="s1">&#39;)&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># omit the first char in the string to force it look for the second</span>
            <span class="c1"># occurrence</span>
            <span class="n">last_pos</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">not_operation</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># not operation - signals that the next substring is just the not operation</span>
            <span class="n">not_shape</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># not shape - signals that the next substring is a not shape</span>
            <span class="k">for</span> <span class="n">shape</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;not|polygon|circle&#39;</span><span class="p">,</span> <span class="n">input_regions</span><span class="p">):</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">shape</span><span class="o">.</span><span class="n">span</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">last_pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">last_pos</span> <span class="o">=</span> <span class="n">pos</span>
                    <span class="k">continue</span>  <span class="c1"># this is the first elem</span>
                <span class="k">if</span> <span class="n">shape</span><span class="o">.</span><span class="n">group</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;not&#39;</span><span class="p">:</span>
                    <span class="n">not_operation</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">not_operation</span><span class="p">:</span>
                    <span class="n">not_shape</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">not_operation</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">last_pos</span> <span class="o">=</span> <span class="n">pos</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">next_shape</span> <span class="o">=</span> <span class="n">_get_region</span><span class="p">(</span>
                        <span class="n">input_regions</span><span class="p">[</span><span class="n">last_pos</span><span class="p">:</span><span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; ()&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">not_shape</span><span class="p">:</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span> <span class="ow">or</span> <span class="n">next_shape</span><span class="p">)</span> <span class="o">^</span> <span class="n">next_shape</span>
                        <span class="n">not_shape</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span> <span class="o">|</span> <span class="n">next_shape</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">_get_region</span><span class="p">(</span>
                        <span class="n">input_regions</span><span class="p">[</span><span class="n">last_pos</span><span class="p">:</span><span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
                <span class="n">last_pos</span> <span class="o">=</span> <span class="n">pos</span>
            <span class="k">if</span> <span class="n">last_pos</span><span class="p">:</span>
                <span class="n">next_shape</span> <span class="o">=</span> <span class="n">_get_region</span><span class="p">(</span>
                    <span class="n">input_regions</span><span class="p">[</span><span class="n">last_pos</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; ()&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">res</span> <span class="o">|</span> <span class="n">next_shape</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">elif</span> <span class="s1">&#39;not&#39;</span> <span class="ow">in</span> <span class="n">s_region</span><span class="p">:</span>
            <span class="c1"># shape with &quot;holes&quot;</span>
            <span class="n">comps</span> <span class="o">=</span> <span class="n">s_region</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;not&#39;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">_get_region</span><span class="p">(</span><span class="n">comps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; ()&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">hole</span> <span class="o">=</span> <span class="n">_get_region</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; ()&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span> <span class="ow">or</span> <span class="n">hole</span><span class="p">)</span> <span class="o">^</span> <span class="n">hole</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_get_region</span><span class="p">(</span><span class="n">s_region</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
    <span class="n">prep_table</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">to_qtable</span><span class="p">()</span>
    <span class="n">s_region_parser</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">resultstable</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;s_region&#39;</span> <span class="o">==</span> <span class="n">field</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="p">(</span><span class="s1">&#39;obscore:Char.SpatialAxis.Coverage.Support.Area&#39;</span> <span class="o">==</span> <span class="n">field</span><span class="o">.</span><span class="n">utype</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;adql:REGION&#39;</span> <span class="o">==</span> <span class="n">field</span><span class="o">.</span><span class="n">xtype</span><span class="p">:</span>
                <span class="n">s_region_parser</span> <span class="o">=</span> <span class="n">_parse_stcs_string</span>
            <span class="c1"># this is where to add other xtype parsers such as shape</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">s_region_parser</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">prep_table</span><span class="p">:</span>
            <span class="n">row</span><span class="p">[</span><span class="s1">&#39;s_region&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_region_parser</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;s_region&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">prep_table</span></div>



<span class="k">class</span> <span class="nc">AlmaAuth</span><span class="p">(</span><span class="n">BaseVOQuery</span><span class="p">,</span> <span class="n">BaseQuery</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Authentication session information for passing credentials to an OIDC instance</span>

<span class="sd">    Assumes an OIDC system like Keycloak with a preconfigured client app called &quot;oidc&quot; to validate against.</span>
<span class="sd">    This does not use Tokens in the traditional OIDC sense, but rather uses the Keycloak specific endpoint</span>
<span class="sd">    to validate a username and password.  Passwords are then kept in a Python keyring.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_CLIENT_ID</span> <span class="o">=</span> <span class="s1">&#39;oidc&#39;</span>
    <span class="n">_GRANT_TYPE</span> <span class="o">=</span> <span class="s1">&#39;password&#39;</span>
    <span class="n">_INVALID_PASSWORD_MESSAGE</span> <span class="o">=</span> <span class="s1">&#39;Invalid user credentials&#39;</span>
    <span class="n">_REALM_ENDPOINT</span> <span class="o">=</span> <span class="s1">&#39;/auth/realms/ALMA&#39;</span>
    <span class="n">_LOGIN_ENDPOINT</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_REALM_ENDPOINT</span><span class="si">}</span><span class="s1">/protocol/openid-connect/token&#39;</span>
    <span class="n">_VERIFY_WELL_KNOWN_ENDPOINT</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_REALM_ENDPOINT</span><span class="si">}</span><span class="s1">/.well-known/openid-configuration&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_auth_hosts</span> <span class="o">=</span> <span class="n">auth_urls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_auth_host</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">auth_hosts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth_hosts</span>

    <span class="nd">@auth_hosts</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">auth_hosts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">auth_hosts</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the available hosts to check for login endpoints.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        auth_hosts : array</span>
<span class="sd">            Available hosts name.  Checking each one until one returns a 200 for</span>
<span class="sd">            the well-known endpoint.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">auth_hosts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LoginError</span><span class="p">(</span><span class="s1">&#39;Valid authentication hosts cannot be None&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_auth_hosts</span> <span class="o">=</span> <span class="n">auth_hosts</span>

    <span class="k">def</span> <span class="nf">get_valid_host</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth_host</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">auth_url</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth_hosts</span><span class="p">:</span>
                <span class="c1"># set session cookies (they do not get set otherwise)</span>
                <span class="n">url_to_check</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;https://</span><span class="si">{</span><span class="n">auth_url</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">_VERIFY_WELL_KNOWN_ENDPOINT</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="s2">&quot;HEAD&quot;</span><span class="p">,</span> <span class="n">url_to_check</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_auth_host</span> <span class="o">=</span> <span class="n">auth_url</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Set auth host to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_auth_host</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">break</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth_host</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LoginError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No useable hosts to login to: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_auth_hosts</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth_host</span>

    <span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Authenticate to one of the configured hosts.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        username : str</span>
<span class="sd">            The username to authenticate with</span>
<span class="sd">        password : str</span>
<span class="sd">            The user&#39;s password</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
            <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
            <span class="s1">&#39;grant_type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GRANT_TYPE</span><span class="p">,</span>
            <span class="s1">&#39;client_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CLIENT_ID</span>
        <span class="p">}</span>

        <span class="n">login_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;https://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_valid_host</span><span class="p">()</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOGIN_ENDPOINT</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Authenticating </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s1"> on </span><span class="si">{</span><span class="n">login_url</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="n">login_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="n">login_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">json_auth</span> <span class="o">=</span> <span class="n">login_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">json_auth</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">json_auth</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="n">json_auth</span><span class="p">[</span><span class="s1">&#39;error_description&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_INVALID_PASSWORD_MESSAGE</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">error_message</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">LoginError</span><span class="p">(</span><span class="s2">&quot;Could not log in to ALMA authorization portal: &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_valid_host</span><span class="p">()</span><span class="si">}</span><span class="s2"> Message from server: </span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">LoginError</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;access_token&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">json_auth</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LoginError</span><span class="p">(</span><span class="s2">&quot;Could not log in to any of the known ALMA authorization portals: </span><span class="se">\n</span><span class="s2">&quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;No error from server, but missing access token from host: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_valid_host</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Successfully logged in to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_auth_host</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="AlmaClass">
<a class="viewcode-back" href="../../../api/astroquery.alma.AlmaClass.html#astroquery.alma.AlmaClass">[docs]</a>
<span class="nd">@async_to_sync</span>
<span class="k">class</span> <span class="nc">AlmaClass</span><span class="p">(</span><span class="n">QueryWithLogin</span><span class="p">):</span>

    <span class="n">TIMEOUT</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">timeout</span>
    <span class="n">archive_url</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">archive_url</span>
    <span class="n">USERNAME</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">username</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># sia service does not need disambiguation but tap does</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sia</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tap</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_datalink</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sia_url</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tap_url</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_datalink_url</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_auth</span> <span class="o">=</span> <span class="n">AlmaAuth</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">auth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">datalink</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datalink</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_datalink</span> <span class="o">=</span> <span class="n">pyvo</span><span class="o">.</span><span class="n">dal</span><span class="o">.</span><span class="n">adhoc</span><span class="o">.</span><span class="n">DatalinkService</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datalink_url</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datalink</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">datalink_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datalink_url</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_datalink_url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_dataarchive_url</span><span class="p">(),</span> <span class="n">DATALINK_SERVICE_PATH</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;ERROR getting the ALMA Archive URL: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">err</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datalink_url</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sia</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sia</span> <span class="o">=</span> <span class="n">SIA2Service</span><span class="p">(</span><span class="n">baseurl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sia_url</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sia</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sia_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sia_url</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sia_url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_dataarchive_url</span><span class="p">(),</span> <span class="n">SIA_SERVICE_PATH</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;ERROR getting the  ALMA Archive URL: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">err</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sia_url</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tap</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tap</span> <span class="o">=</span> <span class="n">pyvo</span><span class="o">.</span><span class="n">dal</span><span class="o">.</span><span class="n">tap</span><span class="o">.</span><span class="n">TAPService</span><span class="p">(</span><span class="n">baseurl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tap_url</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tap</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tap_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tap_url</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tap_url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_dataarchive_url</span><span class="p">(),</span> <span class="n">TAP_SERVICE_PATH</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;ERROR getting the  ALMA Archive URL: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">err</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tap_url</span>

<div class="viewcode-block" id="AlmaClass.query_object_async">
<a class="viewcode-back" href="../../../api/astroquery.alma.AlmaClass.html#astroquery.alma.AlmaClass.query_object_async">[docs]</a>
    <span class="k">def</span> <span class="nf">query_object_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_name</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">public</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">science</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">enhanced_results</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query the archive for a source name.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        object_name : str</span>
<span class="sd">            The object name.  Will be resolved by astropy.coord.SkyCoord</span>
<span class="sd">        public : bool</span>
<span class="sd">            True to return only public datasets, False to return private only,</span>
<span class="sd">            None to return both</span>
<span class="sd">        science : bool</span>
<span class="sd">            True to return only science datasets, False to return only</span>
<span class="sd">            calibration, None to return both</span>
<span class="sd">        enhanced_results : bool</span>
<span class="sd">            True to return a table with quantities instead of just values. It</span>
<span class="sd">            also returns the footprint as `regions` objects.</span>
<span class="sd">        payload : dict</span>
<span class="sd">            Dictionary of additional keywords.  See `help`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;source_name_resolver&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">object_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;source_name_resolver&#39;</span><span class="p">:</span> <span class="n">object_name</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_async</span><span class="p">(</span><span class="n">public</span><span class="o">=</span><span class="n">public</span><span class="p">,</span> <span class="n">science</span><span class="o">=</span><span class="n">science</span><span class="p">,</span>
                                <span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">enhanced_results</span><span class="o">=</span><span class="n">enhanced_results</span><span class="p">,</span>
                                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="AlmaClass.query_region_async">
<a class="viewcode-back" href="../../../api/astroquery.alma.AlmaClass.html#astroquery.alma.AlmaClass.query_region_async">[docs]</a>
    <span class="k">def</span> <span class="nf">query_region_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">public</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">science</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">enhanced_results</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query the ALMA archive with a source name and radius</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        coordinates : str / `astropy.coordinates`</span>
<span class="sd">            the identifier or coordinates around which to query.</span>
<span class="sd">        radius : str / `~astropy.units.Quantity`, optional</span>
<span class="sd">            the radius of the region</span>
<span class="sd">        public : bool</span>
<span class="sd">            True to return only public datasets, False to return private only,</span>
<span class="sd">            None to return both</span>
<span class="sd">        science : bool</span>
<span class="sd">            True to return only science datasets, False to return only</span>
<span class="sd">            calibration, None to return both</span>
<span class="sd">        payload : dict</span>
<span class="sd">            Dictionary of additional keywords.  See `help`.</span>
<span class="sd">        enhanced_results : bool</span>
<span class="sd">            True to return a table with quantities instead of just values. It</span>
<span class="sd">            also returns the footprints as `regions` objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rad</span> <span class="o">=</span> <span class="n">radius</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">):</span>
            <span class="n">rad</span> <span class="o">=</span> <span class="n">radius</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span>
        <span class="n">obj_coord</span> <span class="o">=</span> <span class="n">commons</span><span class="o">.</span><span class="n">parse_coordinates</span><span class="p">(</span><span class="n">coordinate</span><span class="p">)</span><span class="o">.</span><span class="n">icrs</span>
        <span class="n">ra_dec</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj_coord</span><span class="o">.</span><span class="n">to_string</span><span class="p">(),</span> <span class="n">rad</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s1">&#39;ra_dec&#39;</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
            <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;ra_dec&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39; | </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ra_dec</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;ra_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ra_dec</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_async</span><span class="p">(</span><span class="n">public</span><span class="o">=</span><span class="n">public</span><span class="p">,</span> <span class="n">science</span><span class="o">=</span><span class="n">science</span><span class="p">,</span>
                                <span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">enhanced_results</span><span class="o">=</span><span class="n">enhanced_results</span><span class="p">,</span>
                                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="AlmaClass.query_async">
<a class="viewcode-back" href="../../../api/astroquery.alma.AlmaClass.html#astroquery.alma.AlmaClass.query_async">[docs]</a>
    <span class="k">def</span> <span class="nf">query_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">public</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">science</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">legacy_columns</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">get_query_payload</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">maxrec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">enhanced_results</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a generic query with user-specified payload</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        payload : dictionary</span>
<span class="sd">            Please consult the `help` method</span>
<span class="sd">        public : bool</span>
<span class="sd">            True to return only public datasets, False to return private only,</span>
<span class="sd">            None to return both</span>
<span class="sd">        science : bool</span>
<span class="sd">            True to return only science datasets, False to return only</span>
<span class="sd">            calibration, None to return both</span>
<span class="sd">        legacy_columns : bool</span>
<span class="sd">            True to return the columns from the obsolete ALMA advanced query,</span>
<span class="sd">            otherwise return the current columns based on ObsCore model.</span>
<span class="sd">        get_query_payload : bool</span>
<span class="sd">            Flag to indicate whether to simply return the payload.</span>
<span class="sd">        maxrec : integer</span>
<span class="sd">            Cap on the amount of records returned.  Default is no limit.</span>
<span class="sd">        enhanced_results : bool</span>
<span class="sd">            True to return a table with quantities instead of just values. It</span>
<span class="sd">            also returns the footprints as `regions` objects.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        Table with results. Columns are those in the ALMA ObsCore model</span>
<span class="sd">        (see ``help_tap``) unless ``legacy_columns`` argument is set to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;band_list&#39;</span> <span class="o">==</span> <span class="n">arg</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">value</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">payload</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="n">arg</span><span class="p">],</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">payload</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="n">science</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;science_observation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">science</span>
        <span class="k">if</span> <span class="n">public</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;public_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">public</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">_gen_sql</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">get_query_payload</span><span class="p">:</span>
            <span class="c1"># Return the TAP query payload that goes out to the server rather</span>
            <span class="c1"># than the unprocessed payload dict from the python side</span>
            <span class="k">return</span> <span class="n">query</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_tap</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">maxrec</span><span class="o">=</span><span class="n">maxrec</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">enhanced_results</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">get_enhanced_table</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">to_table</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Should not happen</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;BUG: Unexpected result None&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">legacy_columns</span><span class="p">:</span>
            <span class="n">legacy_result</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
            <span class="c1"># add &#39;Observation date&#39; column</span>

            <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">_OBSCORE_TO_ALMARESULT</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">col_name</span> <span class="o">==</span> <span class="s1">&#39;t_min&#39;</span><span class="p">:</span>
                        <span class="n">legacy_result</span><span class="p">[</span><span class="s1">&#39;Observation date&#39;</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="p">[</span><span class="n">Time</span><span class="p">(</span><span class="n">_</span><span class="p">[</span><span class="s1">&#39;t_min&#39;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;mjd&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
                                <span class="n">ALMA_DATE_FORMAT</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">legacy_result</span><span class="p">[</span><span class="n">_OBSCORE_TO_ALMARESULT</span><span class="p">[</span><span class="n">col_name</span><span class="p">]]</span> <span class="o">=</span> \
                            <span class="n">result</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Invalid column mapping in OBSCORE_TO_ALMARESULT: &quot;</span>
                              <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">.  Please &quot;</span>
                              <span class="s2">&quot;report this as an Issue.&quot;</span>
                              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col_name</span><span class="p">,</span> <span class="n">_OBSCORE_TO_ALMARESULT</span><span class="p">[</span><span class="n">col_name</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">legacy_result</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="AlmaClass.query_sia">
<a class="viewcode-back" href="../../../api/astroquery.alma.AlmaClass.html#astroquery.alma.AlmaClass.query_sia">[docs]</a>
    <span class="k">def</span> <span class="nf">query_sia</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">field_of_view</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spatial_resolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">spectral_resolving_power</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exptime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">timeres</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">publisher_did</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">facility</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">instrument</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">calib_level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">res_format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxrec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use standard SIA2 attributes to query the ALMA SIA service.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        _SIA2_PARAMETERS</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Results in `~pyvo.dal.sia2.SIA2Results` format.</span>
<span class="sd">        result.to_qtable in `~astropy.table.QTable` format</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sia</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
            <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span>
            <span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="p">,</span>
            <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span>
            <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span>
            <span class="n">field_of_view</span><span class="o">=</span><span class="n">field_of_view</span><span class="p">,</span>
            <span class="n">spatial_resolution</span><span class="o">=</span><span class="n">spatial_resolution</span><span class="p">,</span>
            <span class="n">spectral_resolving_power</span><span class="o">=</span><span class="n">spectral_resolving_power</span><span class="p">,</span>
            <span class="n">exptime</span><span class="o">=</span><span class="n">exptime</span><span class="p">,</span>
            <span class="n">timeres</span><span class="o">=</span><span class="n">timeres</span><span class="p">,</span>
            <span class="n">publisher_did</span><span class="o">=</span><span class="n">publisher_did</span><span class="p">,</span>
            <span class="n">facility</span><span class="o">=</span><span class="n">facility</span><span class="p">,</span>
            <span class="n">collection</span><span class="o">=</span><span class="n">collection</span><span class="p">,</span>
            <span class="n">instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">,</span>
            <span class="n">data_type</span><span class="o">=</span><span class="n">data_type</span><span class="p">,</span>
            <span class="n">calib_level</span><span class="o">=</span><span class="n">calib_level</span><span class="p">,</span>
            <span class="n">target_name</span><span class="o">=</span><span class="n">target_name</span><span class="p">,</span>
            <span class="n">res_format</span><span class="o">=</span><span class="n">res_format</span><span class="p">,</span>
            <span class="n">maxrec</span><span class="o">=</span><span class="n">maxrec</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


    <span class="n">query_sia</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">query_sia</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_SIA2_PARAMETERS&#39;</span><span class="p">,</span> <span class="n">SIA2_PARAMETERS_DESC</span><span class="p">)</span>

<div class="viewcode-block" id="AlmaClass.query_tap">
<a class="viewcode-back" href="../../../api/astroquery.alma.AlmaClass.html#astroquery.alma.AlmaClass.query_tap">[docs]</a>
    <span class="k">def</span> <span class="nf">query_tap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">maxrec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">uploads</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send query to the ALMA TAP. Results in `~pyvo.dal.TAPResults` format.</span>
<span class="sd">        result.to_qtable in `~astropy.table.QTable` format</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        query : str</span>
<span class="sd">            ADQL query to be executed</span>
<span class="sd">        maxrec : int</span>
<span class="sd">            maximum number of records to return</span>
<span class="sd">        uploads : dict</span>
<span class="sd">            a mapping from temporary table names to objects containing a votable. These</span>
<span class="sd">            temporary tables can be referred to in queries. The keys in the dictionary are</span>
<span class="sd">            the names of temporary tables which need to be prefixed with the TAP_UPLOAD</span>
<span class="sd">            schema in the actual query. The values are either astropy.table.Table instances</span>
<span class="sd">            or file names or file like handles such as io.StringIO to table definition in</span>
<span class="sd">            IVOA VOTable format.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; uploads = {&#39;tmptable&#39;: &#39;/tmp/tmptable_def.xml&#39;}</span>
<span class="sd">    &gt;&gt;&gt; rslt = query_tap(self, query, maxrec=None, uploads=uploads)</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        result : `~pyvo.dal.TAPResults`</span>
<span class="sd">            TAP query result</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;TAP query: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tap</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="s1">&#39;ADQL&#39;</span><span class="p">,</span> <span class="n">maxrec</span><span class="o">=</span><span class="n">maxrec</span><span class="p">,</span> <span class="n">uploads</span><span class="o">=</span><span class="n">uploads</span><span class="p">)</span></div>


<div class="viewcode-block" id="AlmaClass.help_tap">
<a class="viewcode-back" href="../../../api/astroquery.alma.AlmaClass.html#astroquery.alma.AlmaClass.help_tap">[docs]</a>
    <span class="k">def</span> <span class="nf">help_tap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Table to query is &quot;voa.ObsCore&quot;.&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;For example: &quot;select top 1 * from ivoa.ObsCore&quot;&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The scheme of the table is as follows.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">{0:20s}</span><span class="s1"> </span><span class="si">{1:15s}</span><span class="s1"> </span><span class="si">{2:10}</span><span class="s1"> </span><span class="si">{3}</span><span class="s1">&#39;</span><span class="o">.</span>
              <span class="nb">format</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="s1">&#39;Type&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">,</span> <span class="s1">&#39;Description&#39;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">90</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tap</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">tb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ivoa.obscore&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">tb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">content</span> <span class="o">==</span> <span class="s1">&#39;char&#39;</span><span class="p">:</span>
                        <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;char(</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">arraysize</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                    <span class="n">unit</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">unit</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">unit</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">{0:20s}</span><span class="s1"> </span><span class="si">{1:15s}</span><span class="s1"> </span><span class="si">{2:10}</span><span class="s1"> </span><span class="si">{3}</span><span class="s1">&#39;</span><span class="o">.</span>
                          <span class="nb">format</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">description</span><span class="p">))</span></div>


    <span class="c1"># update method pydocs</span>
    <span class="n">query_region_async</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">query_region_async</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
        <span class="s1">&#39;_SIA2_PARAMETERS&#39;</span><span class="p">,</span> <span class="n">SIA2_PARAMETERS_DESC</span><span class="p">)</span>
    <span class="n">query_object_async</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">query_object_async</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
        <span class="s1">&#39;_SIA2_PARAMETERS&#39;</span><span class="p">,</span> <span class="n">SIA2_PARAMETERS_DESC</span><span class="p">)</span>
    <span class="n">query_async</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">query_async</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
        <span class="s1">&#39;_SIA2_PARAMETERS&#39;</span><span class="p">,</span> <span class="n">SIA2_PARAMETERS_DESC</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_dataarchive_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If the generic ALMA URL is used, query it to determine which mirror to</span>
<span class="sd">        access for querying data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;dataarchive_url&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_url</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;http://almascience.org&#39;</span><span class="p">,</span> <span class="s1">&#39;https://almascience.org&#39;</span><span class="p">):</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">,</span>
                                         <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                <span class="c1"># Jan 2017: we have to force https because the archive doesn&#39;t</span>
                <span class="c1"># tell us it needs https.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataarchive_url</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="s2">&quot;/asax/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/aq/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;http://&quot;</span><span class="p">,</span> <span class="s2">&quot;https://&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataarchive_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_url</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataarchive_url</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;http://almascience.org&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;https://almascience.org&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;dataarchive_url&#39; was set to a disambiguation &quot;</span>
                             <span class="s2">&quot;page that is meant to redirect to a real &quot;</span>
                             <span class="s2">&quot;archive.  You should only reach this message &quot;</span>
                             <span class="s2">&quot;if you manually specified Alma.dataarchive_url. &quot;</span>
                             <span class="s2">&quot;If you did so, instead consider setting &quot;</span>
                             <span class="s2">&quot;Alma.archive_url.  Otherwise, report an error &quot;</span>
                             <span class="s2">&quot;on github.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataarchive_url</span>

<div class="viewcode-block" id="AlmaClass.get_data_info">
<a class="viewcode-back" href="../../../api/astroquery.alma.AlmaClass.html#astroquery.alma.AlmaClass.get_data_info">[docs]</a>
    <span class="k">def</span> <span class="nf">get_data_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uids</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">expand_tarfiles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">with_auxiliary</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_rawdata</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return information about the data associated with ALMA uid(s)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        uids : list or str</span>
<span class="sd">            A list of valid UIDs or a single UID.</span>
<span class="sd">            UIDs should have the form: &#39;uid://A002/X391d0b/X7b&#39;</span>
<span class="sd">        expand_tarfiles : bool</span>
<span class="sd">            False to return information on the tarfiles packages containing</span>
<span class="sd">            the data or True to return information about individual files in</span>
<span class="sd">            these packages</span>
<span class="sd">        with_auxiliary : bool</span>
<span class="sd">            True to include the auxiliary packages, False otherwise</span>
<span class="sd">        with_rawdata : bool</span>
<span class="sd">            True to include raw data, False otherwise</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Table with results or None. Table has the following columns: id (UID),</span>
<span class="sd">        access_url (URL to access data), service_def, content_length, content_type (MIME</span>
<span class="sd">        type), semantics, description (optional), error_message (optional)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">uids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;UIDs required&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">uids</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
            <span class="n">uids</span> <span class="o">=</span> <span class="p">[</span><span class="n">uids</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">uids</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Datasets must be given as a list of strings.&quot;</span><span class="p">)</span>
        <span class="c1"># TODO remove this loop and send uids at once when pyvo fixed</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">datalink_service_def_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="n">uids</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datalink</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;OK&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ERROR </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                      <span class="n">res</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

            <span class="c1"># Collect the ad-hoc DataLink services for later retrieval if expand_tarballs is set</span>
            <span class="k">if</span> <span class="n">expand_tarfiles</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">adhoc_service</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">iter_adhocservices</span><span class="p">():</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_datalink_adhoc_service</span><span class="p">(</span><span class="n">adhoc_service</span><span class="p">):</span>
                        <span class="n">datalink_service_def_dict</span><span class="p">[</span><span class="n">adhoc_service</span><span class="o">.</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">adhoc_service</span>

            <span class="n">temp</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">to_table</span><span class="p">()</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">temp</span> <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">vstack</span><span class="p">([</span><span class="n">result</span><span class="p">,</span> <span class="n">temp</span><span class="p">])</span>
            <span class="n">to_delete</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">rr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">rr</span><span class="p">[</span><span class="s1">&#39;error_message&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
                        <span class="n">rr</span><span class="p">[</span><span class="s1">&#39;error_message&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Error accessing info about file </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span>
                                <span class="nb">format</span><span class="p">(</span><span class="n">rr</span><span class="p">[</span><span class="s1">&#39;access_url&#39;</span><span class="p">],</span> <span class="n">rr</span><span class="p">[</span><span class="s1">&#39;error_message&#39;</span><span class="p">]))</span>
                    <span class="c1"># delete from results. Good thing to do?</span>
                    <span class="n">to_delete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">remove_rows</span><span class="p">(</span><span class="n">to_delete</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">with_auxiliary</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">defchararray</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;semantics&#39;</span><span class="p">],</span> <span class="s1">&#39;#aux&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">with_rawdata</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">defchararray</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;semantics&#39;</span><span class="p">],</span> <span class="s1">&#39;#progenitor&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># if expand_tarfiles:</span>
        <span class="c1"># identify the tarballs that can be expandable and replace them</span>
        <span class="c1"># with the list of components</span>
        <span class="n">expanded_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">to_delete</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">expand_tarfiles</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
                <span class="n">service_def_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;service_def&#39;</span><span class="p">]</span>
                <span class="c1"># service_def record, so check if it points to a DataLink document</span>
                <span class="k">if</span> <span class="n">service_def_id</span> <span class="ow">and</span> <span class="n">service_def_id</span> <span class="ow">in</span> <span class="n">datalink_service_def_dict</span><span class="p">:</span>
                    <span class="c1"># subsequent call to datalink</span>
                    <span class="n">adhoc_service</span> <span class="o">=</span> <span class="n">datalink_service_def_dict</span><span class="p">[</span><span class="n">service_def_id</span><span class="p">]</span>
                    <span class="n">recursive_access_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_adhoc_service_access_url</span><span class="p">(</span><span class="n">adhoc_service</span><span class="p">)</span>
                    <span class="n">file_id</span> <span class="o">=</span> <span class="n">recursive_access_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;ID=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">expanded_tar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data_info</span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span>
                    <span class="n">expanded_tar</span> <span class="o">=</span> <span class="n">expanded_tar</span><span class="p">[</span>
                        <span class="n">expanded_tar</span><span class="p">[</span><span class="s1">&#39;semantics&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;#cutout&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">expanded_result</span><span class="p">:</span>
                        <span class="n">expanded_result</span> <span class="o">=</span> <span class="n">expanded_tar</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">expanded_result</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">expanded_result</span><span class="p">,</span> <span class="n">expanded_tar</span><span class="p">],</span> <span class="n">join_type</span><span class="o">=</span><span class="s1">&#39;exact&#39;</span><span class="p">)</span>

                    <span class="c1"># These DataLink entries have no access_url and are links to service_def RESOURCEs only,</span>
                    <span class="c1"># so they can be removed if expanded.</span>
                    <span class="n">to_delete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="c1"># cleanup</span>
        <span class="n">result</span><span class="o">.</span><span class="n">remove_rows</span><span class="p">(</span><span class="n">to_delete</span><span class="p">)</span>
        <span class="c1"># add the extra rows</span>
        <span class="k">if</span> <span class="n">expanded_result</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">([</span><span class="n">result</span><span class="p">,</span> <span class="n">expanded_result</span><span class="p">],</span> <span class="n">join_type</span><span class="o">=</span><span class="s1">&#39;exact&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="AlmaClass.is_datalink_adhoc_service">
<a class="viewcode-back" href="../../../api/astroquery.alma.AlmaClass.html#astroquery.alma.AlmaClass.is_datalink_adhoc_service">[docs]</a>
    <span class="k">def</span> <span class="nf">is_datalink_adhoc_service</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adhoc_service</span><span class="p">):</span>
        <span class="n">standard_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_adhoc_service_parameter</span><span class="p">(</span><span class="n">adhoc_service</span><span class="p">,</span> <span class="s1">&#39;standardID&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">standard_id</span> <span class="o">==</span> <span class="n">DATALINK_STANDARD_ID</span></div>


<div class="viewcode-block" id="AlmaClass.get_adhoc_service_access_url">
<a class="viewcode-back" href="../../../api/astroquery.alma.AlmaClass.html#astroquery.alma.AlmaClass.get_adhoc_service_access_url">[docs]</a>
    <span class="k">def</span> <span class="nf">get_adhoc_service_access_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adhoc_service</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_adhoc_service_parameter</span><span class="p">(</span><span class="n">adhoc_service</span><span class="p">,</span> <span class="s1">&#39;accessURL&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AlmaClass.get_adhoc_service_parameter">
<a class="viewcode-back" href="../../../api/astroquery.alma.AlmaClass.html#astroquery.alma.AlmaClass.get_adhoc_service_parameter">[docs]</a>
    <span class="k">def</span> <span class="nf">get_adhoc_service_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adhoc_service</span><span class="p">,</span> <span class="n">parameter_id</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">adhoc_service</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">ID</span> <span class="o">==</span> <span class="n">parameter_id</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">value</span></div>


<div class="viewcode-block" id="AlmaClass.is_proprietary">
<a class="viewcode-back" href="../../../api/astroquery.alma.AlmaClass.html#astroquery.alma.AlmaClass.is_proprietary">[docs]</a>
    <span class="k">def</span> <span class="nf">is_proprietary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given an ALMA UID, query the servers to determine whether it is</span>
<span class="sd">        proprietary or not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;select distinct data_rights from ivoa.obscore where &quot;</span> \
                <span class="s2">&quot;member_ous_uid=&#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_tap</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">tableresult</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">to_table</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">tableresult</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> not found&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uid</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tableresult</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">tableresult</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Public&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>


    <span class="k">def</span> <span class="nf">_HEADER_data_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a list of file URLs, return the data size.  This is useful for</span>
<span class="sd">        assessing how much data you might be downloading!</span>
<span class="sd">        (This is discouraged by the ALMA archive, as it puts unnecessary load</span>
<span class="sd">        on their system)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">totalsize</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">B</span>
        <span class="n">data_sizes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">pb</span> <span class="o">=</span> <span class="n">ProgressBar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">fileLink</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="s1">&#39;HEAD&#39;</span><span class="p">,</span> <span class="n">fileLink</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">)</span>
            <span class="n">filesize</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;content-length&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">B</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">GB</span><span class="p">)</span>
            <span class="n">totalsize</span> <span class="o">+=</span> <span class="n">filesize</span>
            <span class="n">data_sizes</span><span class="p">[</span><span class="n">fileLink</span><span class="p">]</span> <span class="o">=</span> <span class="n">filesize</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;File </span><span class="si">{0}</span><span class="s2">: size </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fileLink</span><span class="p">,</span> <span class="n">filesize</span><span class="p">))</span>
            <span class="n">pb</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">data_sizes</span><span class="p">,</span> <span class="n">totalsize</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">GB</span><span class="p">)</span>

<div class="viewcode-block" id="AlmaClass.download_files">
<a class="viewcode-back" href="../../../api/astroquery.alma.AlmaClass.html#astroquery.alma.AlmaClass.download_files">[docs]</a>
    <span class="k">def</span> <span class="nf">download_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">savedir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">continuation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skip_unauthorized</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">verify_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a list of file URLs, download them</span>

<span class="sd">        Note: Given a list with repeated URLs, each will only be downloaded</span>
<span class="sd">        once, so the return may have a different length than the input list</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        files : list</span>
<span class="sd">            List of URLs to download</span>
<span class="sd">        savedir : None or str</span>
<span class="sd">            The directory to save to.  Default is the cache location.</span>
<span class="sd">        cache : bool</span>
<span class="sd">            Cache the download?</span>
<span class="sd">        continuation : bool</span>
<span class="sd">            Attempt to continue where the download left off (if it was broken)</span>
<span class="sd">        skip_unauthorized : bool</span>
<span class="sd">            If you receive &quot;unauthorized&quot; responses for some of the download</span>
<span class="sd">            requests, skip over them.  If this is False, an exception will be</span>
<span class="sd">            raised.</span>
<span class="sd">        verify_only : bool</span>
<span class="sd">            Option to go through the process of checking the files to see if</span>
<span class="sd">            they&#39;re the right size, but not actually download them.  This</span>
<span class="sd">            option may be useful if a previous download run failed partway.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">USERNAME</span><span class="p">:</span>
            <span class="n">auth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_auth_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">USERNAME</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">auth</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">downloaded_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">savedir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">savedir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_location</span>
        <span class="k">for</span> <span class="n">file_link</span> <span class="ow">in</span> <span class="n">unique</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Downloading </span><span class="si">{0}</span><span class="s2"> to </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_link</span><span class="p">,</span> <span class="n">savedir</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">check_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="s1">&#39;HEAD&#39;</span><span class="p">,</span> <span class="n">file_link</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">auth</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">)</span>
                <span class="n">check_filename</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ex</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">skip_unauthorized</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Access denied to </span><span class="si">{url}</span><span class="s2">.  Skipping to&quot;</span>
                                 <span class="s2">&quot; next file&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">file_link</span><span class="p">))</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="p">(</span><span class="n">ex</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;filename=(.*)&quot;</span><span class="p">,</span>
                                            <span class="n">check_filename</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to find filename for </span><span class="si">{</span><span class="n">file_link</span><span class="si">}</span><span class="s2">  &quot;</span>
                         <span class="s2">&quot;(missing Content-Disposition in header).  &quot;</span>
                         <span class="s2">&quot;Skipping to next file.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">savedir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savedir</span><span class="p">,</span>
                                        <span class="n">filename</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">verify_only</span><span class="p">:</span>
                <span class="n">existing_file_length</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span>
                <span class="k">if</span> <span class="s1">&#39;content-length&#39;</span> <span class="ow">in</span> <span class="n">check_filename</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
                    <span class="n">length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">check_filename</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;content-length&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;URL </span><span class="si">{0}</span><span class="s1"> has length=0&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_link</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="n">existing_file_length</span> <span class="o">==</span> <span class="n">length</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found cached file </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> with expected size </span><span class="si">{</span><span class="n">existing_file_length</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">existing_file_length</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found cached file </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> with size </span><span class="si">{</span><span class="n">existing_file_length</span><span class="si">}</span><span class="s2"> &lt; expected &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;size </span><span class="si">{</span><span class="n">length</span><span class="si">}</span><span class="s2">.  The download should be continued.&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">existing_file_length</span> <span class="o">&gt;</span> <span class="n">length</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found cached file </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> with size </span><span class="si">{</span><span class="n">existing_file_length</span><span class="si">}</span><span class="s2"> &gt; expected &quot;</span>
                                      <span class="sa">f</span><span class="s2">&quot;size </span><span class="si">{</span><span class="n">length</span><span class="si">}</span><span class="s2">.  The download is likely corrupted.&quot;</span><span class="p">,</span>
                                      <span class="n">CorruptDataWarning</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not verify </span><span class="si">{</span><span class="n">file_link</span><span class="si">}</span><span class="s2"> because it has no &#39;content-length&#39;&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_only</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_download_file</span><span class="p">(</span><span class="n">file_link</span><span class="p">,</span>
                                        <span class="n">filename</span><span class="p">,</span>
                                        <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">,</span>
                                        <span class="n">auth</span><span class="o">=</span><span class="n">auth</span><span class="p">,</span>
                                        <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">,</span>
                                        <span class="n">method</span><span class="o">=</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span>
                                        <span class="n">head_safe</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                        <span class="n">continuation</span><span class="o">=</span><span class="n">continuation</span><span class="p">)</span>

                <span class="n">downloaded_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ex</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">skip_unauthorized</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Access denied to </span><span class="si">{url}</span><span class="s2">.  Skipping to&quot;</span>
                                 <span class="s2">&quot; next file&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">file_link</span><span class="p">))</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="p">(</span><span class="n">ex</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">ex</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">403</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Access denied to </span><span class="si">{url}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">file_link</span><span class="p">))</span>
                    <span class="k">if</span> <span class="s1">&#39;dataPortal&#39;</span> <span class="ow">in</span> <span class="n">file_link</span> <span class="ow">and</span> <span class="s1">&#39;sso&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file_link</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;The URL may be incorrect.  Try using &quot;</span>
                                  <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> instead of </span><span class="si">{1}</span><span class="s2">&quot;</span>
                                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_link</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;dataPortal/&#39;</span><span class="p">,</span>
                                                            <span class="s1">&#39;dataPortal/sso/&#39;</span><span class="p">),</span>
                                          <span class="n">file_link</span><span class="p">))</span>
                    <span class="k">raise</span> <span class="n">ex</span>
                <span class="k">elif</span> <span class="n">ex</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">500</span><span class="p">:</span>
                    <span class="c1"># empirically, this works the second time most of the time...</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_download_file</span><span class="p">(</span><span class="n">file_link</span><span class="p">,</span>
                                        <span class="n">filename</span><span class="p">,</span>
                                        <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">,</span>
                                        <span class="n">auth</span><span class="o">=</span><span class="n">auth</span><span class="p">,</span>
                                        <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">,</span>
                                        <span class="n">method</span><span class="o">=</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span>
                                        <span class="n">head_safe</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                        <span class="n">continuation</span><span class="o">=</span><span class="n">continuation</span><span class="p">)</span>

                    <span class="n">downloaded_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ex</span>
        <span class="k">return</span> <span class="n">downloaded_files</span></div>


    <span class="k">def</span> <span class="nf">_parse_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse a VOtable response</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">commons</span><span class="o">.</span><span class="n">suppress_vo_warnings</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">response</span>

<div class="viewcode-block" id="AlmaClass.retrieve_data_from_uid">
<a class="viewcode-back" href="../../../api/astroquery.alma.AlmaClass.html#astroquery.alma.AlmaClass.retrieve_data_from_uid">[docs]</a>
    <span class="k">def</span> <span class="nf">retrieve_data_from_uid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uids</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stage &amp; Download ALMA data.  Will print out the expected file size</span>
<span class="sd">        before attempting the download.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        uids : list or str</span>
<span class="sd">            A list of valid UIDs or a single UID.</span>
<span class="sd">            UIDs should have the form: &#39;uid://A002/X391d0b/X7b&#39;</span>
<span class="sd">        cache : bool</span>
<span class="sd">            Whether to cache the downloads.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        downloaded_files : list</span>
<span class="sd">            A list of the downloaded file paths</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">uids</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
            <span class="n">uids</span> <span class="o">=</span> <span class="p">[</span><span class="n">uids</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">uids</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Datasets must be given as a list of strings.&quot;</span><span class="p">)</span>

        <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data_info</span><span class="p">(</span><span class="n">uids</span><span class="p">)</span>
        <span class="c1"># filter out blank access URLs</span>
        <span class="c1"># it is possible for there to be length-1 lists</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">file_urls</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="s1">&#39;access_url&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_urls</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">file_urls</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot download uid </span><span class="si">{</span><span class="n">uids</span><span class="si">}</span><span class="s2"> because it has no file&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">file_urls</span> <span class="o">=</span> <span class="p">[</span><span class="n">url</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">files</span><span class="p">[</span><span class="s1">&#39;access_url&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">url</span><span class="p">]</span>

        <span class="n">totalsize</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="s1">&#39;content_length&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">B</span>

        <span class="c1"># each_size, totalsize = self.data_size(files)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Downloading files of size </span><span class="si">{0}</span><span class="s2">...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">totalsize</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">GB</span><span class="p">)))</span>
        <span class="c1"># TODO: Add cache=cache keyword here.  Currently would have no effect.</span>
        <span class="n">downloaded_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_files</span><span class="p">(</span><span class="n">file_urls</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">downloaded_files</span></div>


    <span class="k">def</span> <span class="nf">_get_auth_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">store_password</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">reenter_password</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the auth info (user, password) for use in another function</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">USERNAME</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">LoginError</span><span class="p">(</span><span class="s2">&quot;If you do not pass a username to login(), &quot;</span>
                                 <span class="s2">&quot;you should configure a default one!&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">username</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">USERNAME</span>

        <span class="n">auth_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">get_valid_host</span><span class="p">()</span>

        <span class="c1"># Get password from keyring or prompt</span>
        <span class="n">password</span><span class="p">,</span> <span class="n">password_from_keyring</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_password</span><span class="p">(</span>
            <span class="s2">&quot;astroquery:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">auth_url</span><span class="p">),</span> <span class="n">username</span><span class="p">,</span> <span class="n">reenter</span><span class="o">=</span><span class="n">reenter_password</span><span class="p">)</span>

        <span class="c1"># When authenticated, save password in keyring if needed</span>
        <span class="k">if</span> <span class="n">password_from_keyring</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">store_password</span><span class="p">:</span>
            <span class="n">keyring</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="s2">&quot;astroquery:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">auth_url</span><span class="p">),</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span>

    <span class="k">def</span> <span class="nf">_login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">store_password</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">reenter_password</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">auth_urls</span><span class="o">=</span><span class="n">auth_urls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Login to the ALMA Science Portal.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        username : str, optional</span>
<span class="sd">            Username to the ALMA Science Portal. If not given, it should be</span>
<span class="sd">            specified in the config file.</span>
<span class="sd">        store_password : bool, optional</span>
<span class="sd">            Stores the password securely in your keyring. Default is False.</span>
<span class="sd">        reenter_password : bool, optional</span>
<span class="sd">            Asks for the password even if it is already stored in the</span>
<span class="sd">            keyring. This is the way to overwrite an already stored passwork</span>
<span class="sd">            on the keyring. Default is False.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">auth_hosts</span> <span class="o">=</span> <span class="n">auth_urls</span>

        <span class="n">username</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_auth_info</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
                                                 <span class="n">store_password</span><span class="o">=</span><span class="n">store_password</span><span class="p">,</span>
                                                 <span class="n">reenter_password</span><span class="o">=</span><span class="n">reenter_password</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">USERNAME</span> <span class="o">=</span> <span class="n">username</span>

        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="AlmaClass.get_cycle0_uid_contents">
<a class="viewcode-back" href="../../../api/astroquery.alma.AlmaClass.html#astroquery.alma.AlmaClass.get_cycle0_uid_contents">[docs]</a>
    <span class="k">def</span> <span class="nf">get_cycle0_uid_contents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List the file contents of a UID from Cycle 0.  Will raise an error</span>
<span class="sd">        if the UID is from cycle 1+, since those data have been released in</span>
<span class="sd">        a different and more consistent format.  See</span>
<span class="sd">        https://almascience.nrao.edu/documents-and-tools/cycle-2/ALMAQA2Productsv1.01.pdf</span>
<span class="sd">        for details.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># First, check if UID is in the Cycle 0 listing</span>
        <span class="k">if</span> <span class="n">uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cycle0_table</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]:</span>
            <span class="n">cycle0id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cycle0_table</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cycle0_table</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Files&#39;</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cycle0_tarfile_content</span>
                        <span class="k">if</span> <span class="n">cycle0id</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]]</span>
            <span class="k">return</span> <span class="n">contents</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info_url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_dataarchive_url</span><span class="p">(),</span>
                <span class="s1">&#39;documents-and-tools/cycle-2/ALMAQA2Productsv1.01.pdf&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not a Cycle 0 UID.  See </span><span class="si">{0}</span><span class="s2"> for details about &quot;</span>
                             <span class="s2">&quot;cycle 1+ data release formats.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">info_url</span><span class="p">))</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_cycle0_tarfile_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        In principle, this is a static file, but we&#39;ll retrieve it just in case</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_cycle0_tarfile_content_table&#39;</span><span class="p">):</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_dataarchive_url</span><span class="p">(),</span>
                          <span class="s1">&#39;alma-data/archive/cycle-0-tarfile-content&#39;</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">)</span>

            <span class="c1"># html.parser is needed because some &lt;tr&gt;&#39;s have form:</span>
            <span class="c1"># &lt;tr width=&quot;blah&quot;&gt; which the default parser does not pick up</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">)</span>
            <span class="n">html_table</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s1">&#39;grid listing&#39;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[(</span><span class="n">x</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;td&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
                               <span class="n">x</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;td&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                              <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">html_table</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;tr&#39;</span><span class="p">)]))</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">Column</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ID&#39;</span><span class="p">),</span>
                       <span class="n">Column</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Files&#39;</span><span class="p">)]</span>
            <span class="n">tbl</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8497</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cycle0_tarfile_content_table</span> <span class="o">=</span> <span class="n">tbl</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cycle0_tarfile_content_table</span>
        <span class="k">return</span> <span class="n">tbl</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cycle0_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a table of Cycle 0 Project IDs and associated UIDs.</span>

<span class="sd">        The table is distributed with astroquery and was provided by Felix</span>
<span class="sd">        Stoehr.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_cycle0_table&#39;</span><span class="p">):</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">importlib_resources</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="s1">&#39;astroquery.alma&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;data&#39;</span> <span class="o">/</span> <span class="s1">&#39;cycle0_delivery_asdm_mapping.txt&#39;</span>
            <span class="k">with</span> <span class="n">importlib_resources</span><span class="o">.</span><span class="n">as_file</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span> <span class="k">as</span> <span class="n">path</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cycle0_table</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii.no_header&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cycle0_table</span><span class="o">.</span><span class="n">rename_column</span><span class="p">(</span><span class="s1">&#39;col1&#39;</span><span class="p">,</span> <span class="s1">&#39;ID&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cycle0_table</span><span class="o">.</span><span class="n">rename_column</span><span class="p">(</span><span class="s1">&#39;col2&#39;</span><span class="p">,</span> <span class="s1">&#39;uid&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cycle0_table</span>

<div class="viewcode-block" id="AlmaClass.get_files_from_tarballs">
<a class="viewcode-back" href="../../../api/astroquery.alma.AlmaClass.html#astroquery.alma.AlmaClass.get_files_from_tarballs">[docs]</a>
    <span class="k">def</span> <span class="nf">get_files_from_tarballs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">downloaded_files</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;.*\.fits$&#39;</span><span class="p">,</span>
                                <span class="n">path</span><span class="o">=</span><span class="s1">&#39;cache_path&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a list of successfully downloaded tarballs, extract files</span>
<span class="sd">        with names matching a specified regular expression.  The default</span>
<span class="sd">        is to extract all FITS files</span>

<span class="sd">        NOTE: alma now supports direct listing and downloads of tarballs. See</span>
<span class="sd">        ``get_data_info`` and ``download_and_extract_files``</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        downloaded_files : list</span>
<span class="sd">            A list of downloaded files.  These should be paths on your local</span>
<span class="sd">            machine.</span>
<span class="sd">        regex : str</span>
<span class="sd">            A valid regular expression</span>
<span class="sd">        path : &#39;cache_path&#39; or str</span>
<span class="sd">            If &#39;cache_path&#39;, will use the astroquery.Alma cache directory</span>
<span class="sd">            (``Alma.cache_location``), otherwise will use the specified path.</span>
<span class="sd">            Note that the subdirectory structure of the tarball will be</span>
<span class="sd">            maintained.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        filelist : list</span>
<span class="sd">            A list of the extracted file locations on disk</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="s1">&#39;cache_path&#39;</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_location</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;Specified an invalid path </span><span class="si">{0}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

        <span class="n">fitsre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span>

        <span class="n">filelist</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">downloaded_files</span><span class="p">:</span>
            <span class="n">tf</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">tf</span><span class="o">.</span><span class="n">getmembers</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">fitsre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">member</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Extracting </span><span class="si">{0}</span><span class="s2"> to </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">member</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                                <span class="n">path</span><span class="p">))</span>
                    <span class="n">tf</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                    <span class="n">filelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">member</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">filelist</span></div>


<div class="viewcode-block" id="AlmaClass.download_and_extract_files">
<a class="viewcode-back" href="../../../api/astroquery.alma.AlmaClass.html#astroquery.alma.AlmaClass.download_and_extract_files">[docs]</a>
    <span class="k">def</span> <span class="nf">download_and_extract_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">urls</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;.*\.fits$&#39;</span><span class="p">,</span>
                                   <span class="n">include_asdm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;cache_path&#39;</span><span class="p">,</span>
                                   <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a list of tarball URLs, it extracts all the FITS files (or</span>
<span class="sd">        whatever matches the regex)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        urls : str or list</span>
<span class="sd">            A single URL or a list of URLs</span>
<span class="sd">        include_asdm : bool</span>
<span class="sd">            Only affects cycle 1+ data.  If set, the ASDM files will be</span>
<span class="sd">            downloaded in addition to the script and log files.  By default,</span>
<span class="sd">            though, this file will be downloaded and deleted without extracting</span>
<span class="sd">            any information: you must change the regex if you want to extract</span>
<span class="sd">            data from an ASDM tarball</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">urls</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">urls</span> <span class="o">=</span> <span class="p">[</span><span class="n">urls</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">urls</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Datasets must be given as a list of strings.&quot;</span><span class="p">)</span>
        <span class="n">filere</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span>

        <span class="n">all_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tar_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">expanded_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">url</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">!=</span> <span class="s1">&#39;.tar&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;URLs should be links to tarballs.&quot;</span><span class="p">)</span>

            <span class="n">tarfile_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">url</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tarfile_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cycle0_tarfile_content</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]:</span>
                <span class="c1"># It is a cycle 0 file: need to check if it contains FITS</span>
                <span class="n">match</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle0_tarfile_content</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tarfile_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">_cycle0_tarfile_content</span><span class="p">[</span><span class="s1">&#39;Files&#39;</span><span class="p">][</span><span class="n">match</span><span class="p">]):</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No FITS files found in </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tarfile_name</span><span class="p">))</span>
                    <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;asdm&#39;</span> <span class="ow">in</span> <span class="n">tarfile_name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">include_asdm</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ASDM tarballs do not contain FITS files; &quot;</span>
                             <span class="s2">&quot;skipping.&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

            <span class="n">tar_file</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data_info</span><span class="p">(</span><span class="n">tar_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">expanded_files</span> <span class="o">+=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">files</span><span class="p">[</span><span class="s1">&#39;access_url&#39;</span><span class="p">]</span> <span class="k">if</span>
                                   <span class="n">filere</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tar_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># get the tar files</span>
            <span class="n">downloaded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_files</span><span class="p">(</span><span class="n">tar_files</span><span class="p">,</span> <span class="n">savedir</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
            <span class="n">fitsfilelist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_files_from_tarballs</span><span class="p">(</span><span class="n">downloaded</span><span class="p">,</span>
                                                        <span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
                                                        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">delete</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">tarball_name</span> <span class="ow">in</span> <span class="n">downloaded</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleting </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tarball_name</span><span class="p">))</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tarball_name</span><span class="p">)</span>

            <span class="n">all_files</span> <span class="o">+=</span> <span class="n">fitsfilelist</span>

            <span class="c1"># download the other files</span>
            <span class="n">all_files</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_files</span><span class="p">(</span><span class="n">expanded_files</span><span class="p">,</span> <span class="n">savedir</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">ConnectionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">partial_file_list</span> <span class="o">=</span> <span class="n">all_files</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;There was an error downloading the file. &quot;</span>
                      <span class="s2">&quot;A partially completed download list is &quot;</span>
                      <span class="s2">&quot;in Alma.partial_file_list&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ex</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ex</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Access denied to </span><span class="si">{url}</span><span class="s2">.  Skipping to&quot;</span>
                         <span class="s2">&quot; next file&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ex</span>
        <span class="k">return</span> <span class="n">all_files</span></div>


<div class="viewcode-block" id="AlmaClass.help">
<a class="viewcode-back" href="../../../api/astroquery.alma.AlmaClass.html#astroquery.alma.AlmaClass.help">[docs]</a>
    <span class="k">def</span> <span class="nf">help</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the valid query parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Most common ALMA query keywords are listed below. These &quot;</span>
              <span class="s2">&quot;keywords are part of the ALMA ObsCore model, an IVOA standard &quot;</span>
              <span class="s2">&quot;for metadata representation (3rd column). They were also &quot;</span>
              <span class="s2">&quot;present in original ALMA Web form and, for backwards &quot;</span>
              <span class="s2">&quot;compatibility can be accessed with their old names (2nd &quot;</span>
              <span class="s2">&quot;column).</span><span class="se">\n</span><span class="s2">&quot;</span>
              <span class="s2">&quot;More elaborate queries on the ObsCore model &quot;</span>
              <span class="s2">&quot;are possible with `query_sia` or `query_tap` methods&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">{0:33s}</span><span class="s2"> </span><span class="si">{1:35s}</span><span class="s2"> </span><span class="si">{2:35s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Description&quot;</span><span class="p">,</span>
                                                 <span class="s2">&quot;Original ALMA keyword&quot;</span><span class="p">,</span>
                                                 <span class="s2">&quot;ObsCore keyword&quot;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">103</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">title</span><span class="p">,</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">ALMA_FORM_KEYS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">section</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">{0:33s}</span><span class="s2"> </span><span class="si">{1:35s}</span><span class="s2"> </span><span class="si">{2:35s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Examples of queries:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Alma.query(&#39;proposal_id&#39;:&#39;2011.0.00131.S&#39;}&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Alma.query({&#39;band_list&#39;: [&#39;5&#39;, &#39;7&#39;]}&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Alma.query({&#39;source_name_alma&#39;: &#39;GRB021004&#39;})&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Alma.query(payload=dict(project_code=&#39;2017.1.01355.L&#39;, &quot;</span>
              <span class="s2">&quot;source_name_alma=&#39;G008.67&#39;))&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AlmaClass.get_project_metadata">
<a class="viewcode-back" href="../../../api/astroquery.alma.AlmaClass.html#astroquery.alma.AlmaClass.get_project_metadata">[docs]</a>
    <span class="k">def</span> <span class="nf">get_project_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">projectid</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the metadata - specifically, the project abstract - for a given project ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">projectid</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">14</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Wrong length for project ID&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">projectid</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">projectid</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="n">projectid</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Wrong format for project ID&#39;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_tap</span><span class="p">(</span>
            <span class="s2">&quot;select distinct proposal_abstract from &quot;</span>
            <span class="s2">&quot;ivoa.obscore where proposal_id=&#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">projectid</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;proposal_abstract&#39;</span><span class="p">]]</span></div>
</div>



<span class="n">Alma</span> <span class="o">=</span> <span class="n">AlmaClass</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">clean_uid</span><span class="p">(</span><span class="n">uid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a uid with all unacceptable characters replaced with underscores</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">clean_uid</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">uid</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;S&#39;</span><span class="p">)))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">uid</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="sa">u</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="sa">u</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">uid</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">reform_uid</span><span class="p">(</span><span class="n">uid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a uid with underscores to the original format</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">uid</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;://&quot;</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">uid</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">unique</span><span class="p">(</span><span class="n">seq</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return unique elements of a list, preserving order</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">seen_add</span> <span class="o">=</span> <span class="n">seen</span><span class="o">.</span><span class="n">add</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">seq</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">seen</span> <span class="ow">or</span> <span class="n">seen_add</span><span class="p">(</span><span class="n">x</span><span class="p">))]</span>


<span class="k">def</span> <span class="nf">filter_printable</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; extract printable characters from a string &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">printable</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">uid_json_to_table</span><span class="p">(</span><span class="n">jdata</span><span class="p">,</span>
                      <span class="n">productlist</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ASDM&#39;</span><span class="p">,</span> <span class="s1">&#39;PIPELINE_PRODUCT&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;PIPELINE_PRODUCT_TARFILE&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;PIPELINE_AUXILIARY_TARFILE&#39;</span><span class="p">]):</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">flatten_jdata</span><span class="p">(</span><span class="n">this_jdata</span><span class="p">,</span> <span class="n">mousID</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">this_jdata</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">this_jdata</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">productlist</span><span class="p">:</span>
                    <span class="n">item</span><span class="p">[</span><span class="s1">&#39;mous_uid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mousID</span>
                    <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;allMousUids&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">flatten_jdata</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;allMousUids&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">flatten_jdata</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">])</span>

    <span class="n">flatten_jdata</span><span class="p">(</span><span class="n">jdata</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">])</span>

    <span class="n">keys</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">Column</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
               <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;children&#39;</span><span class="p">,</span> <span class="s1">&#39;allMousUids&#39;</span><span class="p">)]</span>

    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span> <span class="k">else</span> <span class="n">col</span> <span class="k">for</span> <span class="n">col</span>
               <span class="ow">in</span> <span class="n">columns</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">Table</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2025, The Astroquery Developers.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 7.4.7. &nbsp;
    Last built 01 Apr 2025. <br/>
  </p>
</footer>
  </body>
</html>