<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>astroquery.cadc.core &#8212; astroquery v0.4.8.dev10177</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/bootstrap-astropy.css?v=9d21690f" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=fd3f3429" />
    <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
    
    <script src="../../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../../../_static/documentation_options.js?v=51006566"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../_static/copybutton.js"></script>
    <link rel="icon" href="../../../_static/astropy_logo.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../index.html"><span id="logotext1">astro</span><span id="logotext2">query</span><span id="logotext3">:docs</span></a>
  <ul>
    
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../index.html">astroquery v0.4.8.dev10177</a>
	 &#187;
      </li>
      <li><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for astroquery.cadc.core</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">CADC</span>
<span class="sd">====</span>


<span class="sd">Module to query the Canadian Astronomy Data Centre (CADC).</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">astroquery</span> <span class="kn">import</span> <span class="n">log</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">ma</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlencode</span>
<span class="kn">from</span> <span class="nn">urllib.error</span> <span class="kn">import</span> <span class="n">HTTPError</span>

<span class="kn">from</span> <span class="nn">..utils.class_or_instance</span> <span class="kn">import</span> <span class="n">class_or_instance</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">async_to_sync</span><span class="p">,</span> <span class="n">commons</span>
<span class="kn">from</span> <span class="nn">..query</span> <span class="kn">import</span> <span class="n">BaseQuery</span><span class="p">,</span> <span class="n">BaseVOQuery</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">Angle</span>
<span class="kn">import</span> <span class="nn">pyvo</span>
<span class="kn">from</span> <span class="nn">pyvo.auth</span> <span class="kn">import</span> <span class="n">authsession</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">conf</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Cadc&#39;</span><span class="p">,</span> <span class="s1">&#39;CadcClass&#39;</span><span class="p">]</span>

<span class="n">CADC_COOKIE_PREFIX</span> <span class="o">=</span> <span class="s1">&#39;CADC_SSO&#39;</span>

<span class="c1"># TODO figure out what to do if anything about them. Some might require</span>
<span class="c1"># fixes on the CADC servers</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">&#39;astropy.io.votable&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="CadcClass">
<a class="viewcode-back" href="../../../api/astroquery.cadc.CadcClass.html#astroquery.cadc.CadcClass">[docs]</a>
<span class="nd">@async_to_sync</span>
<span class="k">class</span> <span class="nc">CadcClass</span><span class="p">(</span><span class="n">BaseVOQuery</span><span class="p">,</span> <span class="n">BaseQuery</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for accessing CADC data. Typical usage:</span>

<span class="sd">    result = Cadc.query_region(&#39;08h45m07.5s +54d18m00s&#39;, collection=&#39;CFHT&#39;)</span>

<span class="sd">    ... do something with result (optional) such as filter as in example below</span>

<span class="sd">    urls = Cadc.get_data_urls(result[result[&#39;target_name&#39;]==&#39;Nr3491_1&#39;])</span>

<span class="sd">    ... access data</span>

<span class="sd">    Other ways to query the CADC data storage:</span>

<span class="sd">    - target name:</span>
<span class="sd">        Cadc.query_region(SkyCoord.from_name(&#39;M31&#39;))</span>
<span class="sd">    - target name in the metadata:</span>
<span class="sd">        Cadc.query_name(&#39;M31-A-6&#39;)  # queries as a like &#39;%lower(name)%&#39;</span>
<span class="sd">    - TAP query on the CADC metadata (CAOM2 format -</span>
<span class="sd">        http://www.opencadc.org/caom2/)</span>
<span class="sd">        Cadc.get_tables()  # list the tables</span>
<span class="sd">        Cadc.get_table(table_name)  # list table schema</span>
<span class="sd">        Cadc.query</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CADC_REGISTRY_URL</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">CADC_REGISTRY_URL</span>
    <span class="n">CADCTAP_SERVICE_URI</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">CADCTAP_SERVICE_URI</span>
    <span class="n">CADCDATALINK_SERVICE_URI</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">CADCDATLINK_SERVICE_URI</span>
    <span class="n">CADCLOGIN_SERVICE_URI</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">CADCLOGIN_SERVICE_URI</span>
    <span class="n">TIMEOUT</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">TIMEOUT</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">auth_session</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize Cadc object</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        url : str, optional, default &#39;None;</span>
<span class="sd">            a url to use instead of the default</span>
<span class="sd">        auth_session: `requests.Session` or `pyvo.auth.authsession.AuthSession`</span>
<span class="sd">            A existing authenticated session containing the appropriate</span>
<span class="sd">            credentials to be used by the client to communicate with the</span>
<span class="sd">            server. This is an alternative to using login/logout methods that</span>
<span class="sd">            allows clients to reuse existing session with multiple services.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Cadc object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseurl</span> <span class="o">=</span> <span class="n">url</span>
        <span class="c1"># _auth_session contains the credentials that are used by both</span>
        <span class="c1"># the cadc tap and cadc datalink services</span>
        <span class="k">if</span> <span class="n">auth_session</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_auth_session</span> <span class="o">=</span> <span class="n">auth_session</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_auth_session</span> <span class="o">=</span> <span class="n">authsession</span><span class="o">.</span><span class="n">AuthSession</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cadctap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_cadctap&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseurl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">baseurl</span> <span class="o">=</span> <span class="n">get_access_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CADCTAP_SERVICE_URI</span><span class="p">)</span>
                <span class="c1"># remove capabilities endpoint to get to the service url</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">baseurl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseurl</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;capabilities&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cadctap</span> <span class="o">=</span> <span class="n">pyvo</span><span class="o">.</span><span class="n">dal</span><span class="o">.</span><span class="n">TAPService</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">baseurl</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_auth_session</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cadctap</span> <span class="o">=</span> <span class="n">pyvo</span><span class="o">.</span><span class="n">dal</span><span class="o">.</span><span class="n">TAPService</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">baseurl</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_auth_session</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cadctap</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cadcdatalink</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_datalink&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_datalink</span> <span class="o">=</span> <span class="n">pyvo</span><span class="o">.</span><span class="n">dal</span><span class="o">.</span><span class="n">adhoc</span><span class="o">.</span><span class="n">DatalinkService</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_link_url</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_auth_session</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datalink</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_link_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_data_link_url&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_link_url</span> <span class="o">=</span> <span class="n">get_access_url</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">CADCDATALINK_SERVICE_URI</span><span class="p">,</span>
                <span class="n">capability</span><span class="o">=</span><span class="s2">&quot;ivo://ivoa.net/std/DataLink#links-1.0&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_link_url</span>

<div class="viewcode-block" id="CadcClass.login">
<a class="viewcode-back" href="../../../api/astroquery.cadc.CadcClass.html#astroquery.cadc.CadcClass.login">[docs]</a>
    <span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">certificate_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        login allows user to authenticate to the service. Both user/password</span>
<span class="sd">        and https client certificates are supported.</span>

<span class="sd">         Alternatively, the Cadc class can be instantiated with an</span>
<span class="sd">         authenticated session.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        user : str, required if certificate is None</span>
<span class="sd">            username to login with</span>
<span class="sd">        password : str, required if user is set</span>
<span class="sd">            password to login with</span>
<span class="sd">        certificate : str, required if user is None</span>
<span class="sd">            path to certificate to use with logging in</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># start with a new session</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cadctap</span><span class="o">.</span><span class="n">_session</span><span class="p">,</span> <span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">,</span>
                                                  <span class="n">authsession</span><span class="o">.</span><span class="n">AuthSession</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Cannot login with user provided session that is &#39;</span>
                                 <span class="s1">&#39;not an pyvo.authsession.AuthSession or &#39;</span>
                                 <span class="s1">&#39;requests.Session&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">certificate_file</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">user</span> <span class="ow">and</span> <span class="n">password</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;login credentials missing (user/password &#39;</span>
                                 <span class="s1">&#39;or certificate)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">certificate_file</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cadctap</span><span class="o">.</span><span class="n">_session</span><span class="p">,</span> <span class="n">authsession</span><span class="o">.</span><span class="n">AuthSession</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cadctap</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">credentials</span><span class="o">.</span>\
                    <span class="n">set_client_certificate</span><span class="p">(</span><span class="n">certificate_file</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># if the session was already used to call CADC, requests caches</span>
                <span class="c1"># it without using the cert. Therefore need to close all</span>
                <span class="c1"># existing https sessions first.</span>
                <span class="n">https_adapter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cadctap</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">adapters</span><span class="p">[</span><span class="s1">&#39;https://&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">https_adapter</span><span class="p">:</span>
                    <span class="n">https_adapter</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cadctap</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">cert</span> <span class="o">=</span> <span class="n">certificate_file</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">password</span><span class="p">:</span>
            <span class="n">login_url</span> <span class="o">=</span> <span class="n">get_access_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CADCLOGIN_SERVICE_URI</span><span class="p">,</span>
                                       <span class="n">capability</span><span class="o">=</span><span class="s1">&#39;ivo://ivoa.net/std/UMS#login-0.1&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">login_url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No login URL&quot;</span><span class="p">)</span>
            <span class="c1"># need to login and get a cookie</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">),</span>
                <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">password</span><span class="p">)}</span>
            <span class="n">header</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;Content-type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/x-www-form-urlencoded&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;text/plain&quot;</span>
            <span class="p">}</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">login_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
                                     <span class="n">headers</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Logging error: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">e</span>
            <span class="c1"># extract cookie</span>
            <span class="n">cookie</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cookie</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cadctap</span><span class="o">.</span><span class="n">_session</span><span class="p">,</span> <span class="n">authsession</span><span class="o">.</span><span class="n">AuthSession</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cadctap</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">credentials</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span>
                        <span class="n">CADC_COOKIE_PREFIX</span><span class="p">,</span> <span class="n">cookie</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cadctap</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                        <span class="n">CADC_COOKIE_PREFIX</span><span class="p">,</span> <span class="n">cookie</span><span class="p">)</span></div>


<div class="viewcode-block" id="CadcClass.logout">
<a class="viewcode-back" href="../../../api/astroquery.cadc.CadcClass.html#astroquery.cadc.CadcClass.logout">[docs]</a>
    <span class="k">def</span> <span class="nf">logout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Logout. Anonymous access with all the subsequent use of the</span>
<span class="sd">        object. Note that the original session is not affected (in case</span>
<span class="sd">        it was passed when the object was first instantiated)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_auth_session</span><span class="p">,</span> <span class="n">pyvo</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">AuthSession</span><span class="p">):</span>
            <span class="c1"># Remove the existing credentials (if any)</span>
            <span class="c1"># PyVO should provide this reset credentials functionality</span>
            <span class="c1"># TODO - this should be implemented in PyVO to avoid this deep</span>
            <span class="c1"># intrusion into that package</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_auth_session</span><span class="o">.</span><span class="n">credentials</span><span class="o">.</span><span class="n">credentials</span> <span class="o">=</span> \
                <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth_session</span><span class="o">.</span><span class="n">credentials</span><span class="o">.</span><span class="n">credentials</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">pyvo</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">securitymethods</span><span class="o">.</span><span class="n">ANONYMOUS</span><span class="p">}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_auth_session</span><span class="p">,</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">):</span>
            <span class="c1"># the only way to ensure complete logout is to start with a new</span>
            <span class="c1"># session. This is mainly because of certificates. Removing cert</span>
            <span class="c1"># argument to a session already in use does not force it to</span>
            <span class="c1"># re-do the HTTPS hand shake</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_auth_session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cadctap</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth_session</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cadcdatalink</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth_session</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s1">&#39;Do not know how to log out from custom session&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CadcClass.query_region_async">
<a class="viewcode-back" href="../../../api/astroquery.cadc.CadcClass.html#astroquery.cadc.CadcClass.query_region_async">[docs]</a>
    <span class="nd">@class_or_instance</span>
    <span class="k">def</span> <span class="nf">query_region_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.016666666666667</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
                           <span class="n">collection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">get_query_payload</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Queries the CADC for a region around the specified coordinates.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        coordinates : str or `astropy.coordinates`.</span>
<span class="sd">            coordinates around which to query</span>
<span class="sd">        radius : str or `astropy.units.Quantity`.</span>
<span class="sd">            the radius of the cone search</span>
<span class="sd">        collection: Name of the CADC collection to query, optional</span>
<span class="sd">        get_query_payload : bool, optional</span>
<span class="sd">            Just return the dict of HTTP request parameters.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        response : `requests.Response`</span>
<span class="sd">            The HTTP response returned from the service.</span>
<span class="sd">            All async methods should return the raw HTTP response.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Radius should be of type str or &#39;</span>
                          <span class="s1">&#39;`astropy.units.Quantity`&#39;</span><span class="p">)</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>

        <span class="n">request_payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args_to_payload</span><span class="p">(</span><span class="n">coordinates</span><span class="o">=</span><span class="n">coordinates</span><span class="p">,</span>
                                                <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span>
                                                <span class="n">collection</span><span class="o">=</span><span class="n">collection</span><span class="p">)</span>
        <span class="c1"># primarily for debug purposes, but also useful if you want to send</span>
        <span class="c1"># someone a URL linking directly to the data</span>
        <span class="k">if</span> <span class="n">get_query_payload</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">request_payload</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_sync</span><span class="p">(</span><span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">response</span></div>


<div class="viewcode-block" id="CadcClass.query_name_async">
<a class="viewcode-back" href="../../../api/astroquery.cadc.CadcClass.html#astroquery.cadc.CadcClass.query_name_async">[docs]</a>
    <span class="nd">@class_or_instance</span>
    <span class="k">def</span> <span class="nf">query_name_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query CADC metadata for a name and return the corresponding metadata in</span>
<span class="sd">         the CAOM2 format (http://www.opencadc.org/caom2/).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">                name of object to query for</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        response : `~astropy.table.Table`</span>
<span class="sd">            Results of the query in a tabular format.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_sync</span><span class="p">(</span>
            <span class="s2">&quot;select * from caom2.Observation o join caom2.Plane p &quot;</span>
            <span class="s2">&quot;on o.obsID=p.obsID where lower(target_name) like &#39;%</span><span class="si">{}</span><span class="s2">%&#39;&quot;</span><span class="o">.</span>
            <span class="nb">format</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">response</span></div>


<div class="viewcode-block" id="CadcClass.get_collections">
<a class="viewcode-back" href="../../../api/astroquery.cadc.CadcClass.html#astroquery.cadc.CadcClass.get_collections">[docs]</a>
    <span class="nd">@class_or_instance</span>
    <span class="k">def</span> <span class="nf">get_collections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query CADC for all the hosted collections</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A dictionary of collections hosted at the CADC where the key is the</span>
<span class="sd">        collection and value represents details of that collection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_sync</span><span class="p">(</span>
            <span class="s1">&#39;select distinct collection, energy_emBand from caom2.EnumField&#39;</span><span class="p">)</span>
        <span class="n">collections</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">collections</span><span class="p">:</span>
                <span class="n">collection</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;Description&#39;</span><span class="p">:</span> <span class="s1">&#39;The </span><span class="si">{}</span><span class="s1"> collection at the CADC&#39;</span><span class="o">.</span>
                    <span class="nb">format</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">]),</span> <span class="s1">&#39;Bands&#39;</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;energy_emBand&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span><span class="p">:</span>
                    <span class="n">collection</span><span class="p">[</span><span class="s1">&#39;Bands&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;energy_emBand&#39;</span><span class="p">])</span>
                <span class="n">collections</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">collection</span>
            <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;energy_emBand&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span><span class="p">:</span>
                <span class="n">collections</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">]][</span><span class="s1">&#39;Bands&#39;</span><span class="p">]</span><span class="o">.</span>\
                    <span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;energy_emBand&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">collections</span></div>


<div class="viewcode-block" id="CadcClass.get_images">
<a class="viewcode-back" href="../../../api/astroquery.cadc.CadcClass.html#astroquery.cadc.CadcClass.get_images">[docs]</a>
    <span class="nd">@class_or_instance</span>
    <span class="k">def</span> <span class="nf">get_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                   <span class="n">collection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">get_url_list</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">show_progress</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A coordinate-based query function that returns a list of</span>
<span class="sd">        fits files with cutouts around the passed in coordinates.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        coordinates : str or `astropy.coordinates`.</span>
<span class="sd">            Coordinates around which to query.</span>
<span class="sd">        radius : str or `astropy.units.Quantity`</span>
<span class="sd">            The radius of the cone search AND cutout area.</span>
<span class="sd">        collection : str, optional</span>
<span class="sd">            Name of the CADC collection to query.</span>
<span class="sd">        get_url_list : bool, optional</span>
<span class="sd">            If ``True``, returns the list of data urls rather than</span>
<span class="sd">            the downloaded FITS files. Default is ``False``.</span>
<span class="sd">        show_progress : bool, optional</span>
<span class="sd">            Whether to display a progress bar if the file is downloaded</span>
<span class="sd">            from a remote server.  Default is ``False``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list : A list of `~astropy.io.fits.HDUList` objects (or a list of</span>
<span class="sd">        str if returning urls).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">filenames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_images_async</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="n">collection</span><span class="p">,</span>
                                          <span class="n">get_url_list</span><span class="o">=</span><span class="n">get_url_list</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="n">show_progress</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">get_url_list</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">filenames</span>

        <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">get_fits</span><span class="p">())</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">,</span> <span class="n">HTTPError</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="c1"># Catch HTTPError if user is unauthorized to access file</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> - Problem retrieving the file: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span>
                    <span class="nb">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">url</span><span class="p">)))</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="n">images</span></div>


<div class="viewcode-block" id="CadcClass.get_images_async">
<a class="viewcode-back" href="../../../api/astroquery.cadc.CadcClass.html#astroquery.cadc.CadcClass.get_images_async">[docs]</a>
    <span class="k">def</span> <span class="nf">get_images_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">get_url_list</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A coordinate-based query function that returns a list of</span>
<span class="sd">        context managers with cutouts around the passed in coordinates.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        coordinates : str or `astropy.coordinates`.</span>
<span class="sd">            Coordinates around which to query.</span>
<span class="sd">        radius : str or `astropy.units.Quantity`</span>
<span class="sd">            The radius of the cone search AND cutout area.</span>
<span class="sd">        collection : str, optional</span>
<span class="sd">            Name of the CADC collection to query.</span>
<span class="sd">        get_url_list : bool, optional</span>
<span class="sd">            If ``True``, returns the list of data urls rather than</span>
<span class="sd">            the list of context managers. Default is ``False``.</span>
<span class="sd">        show_progress : bool, optional</span>
<span class="sd">            Whether to display a progress bar if the file is downloaded</span>
<span class="sd">            from a remote server.  Default is ``False``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list : A list of context-managers that yield readable file-like objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">request_payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args_to_payload</span><span class="p">(</span><span class="n">coordinates</span><span class="o">=</span><span class="n">coordinates</span><span class="p">,</span>
                                                <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span>
                                                <span class="n">collection</span><span class="o">=</span><span class="n">collection</span><span class="p">,</span>
                                                <span class="n">data_product_type</span><span class="o">=</span><span class="s1">&#39;image&#39;</span><span class="p">)</span>
        <span class="n">query_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_sync</span><span class="p">(</span><span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">])</span>
        <span class="n">images_urls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_image_list</span><span class="p">(</span><span class="n">query_result</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">get_url_list</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">images_urls</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">commons</span><span class="o">.</span><span class="n">FileContainer</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span>
                                      <span class="n">show_progress</span><span class="o">=</span><span class="n">show_progress</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">images_urls</span><span class="p">]</span></div>


<div class="viewcode-block" id="CadcClass.get_image_list">
<a class="viewcode-back" href="../../../api/astroquery.cadc.CadcClass.html#astroquery.cadc.CadcClass.get_image_list">[docs]</a>
    <span class="k">def</span> <span class="nf">get_image_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_result</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">,</span> <span class="n">radius</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to map the results of a CADC query into URLs to</span>
<span class="sd">        corresponding data and cutouts that can be later downloaded.</span>

<span class="sd">        The function uses the IVOA DataLink Service</span>
<span class="sd">        (http://www.ivoa.net/documents/DataLink/) implemented at the CADC.</span>
<span class="sd">        It works directly with the results produced by `query_region` and</span>
<span class="sd">        `query_name` but in principle it can work with other query</span>
<span class="sd">        results produced with the Cadc query as long as the results</span>
<span class="sd">        contain the &#39;publisherID&#39; column. This column is part of the</span>
<span class="sd">        &#39;caom2.Plane&#39; table.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        query_result : A `~astropy.table.Table` object</span>
<span class="sd">            Result returned by `query_region` or</span>
<span class="sd">            `query_name`. In general, the result of any</span>
<span class="sd">            CADC TAP query that contains the &#39;publisherID&#39;</span>
<span class="sd">            column can be used here.</span>
<span class="sd">        coordinates : str or `astropy.coordinates`.</span>
<span class="sd">            Center of the cutout area.</span>
<span class="sd">        radius : str or `astropy.units.Quantity`.</span>
<span class="sd">            The radius of the cutout area.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list : A list of URLs to cutout data.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">query_result</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Missing query_result argument&#39;</span><span class="p">)</span>

        <span class="n">parsed_coordinates</span> <span class="o">=</span> <span class="n">commons</span><span class="o">.</span><span class="n">parse_coordinates</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span><span class="o">.</span><span class="n">fk5</span>
        <span class="n">radius_deg</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
        <span class="n">ra</span> <span class="o">=</span> <span class="n">parsed_coordinates</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">degree</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">parsed_coordinates</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">degree</span>
        <span class="n">cutout_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;POS&#39;</span><span class="p">:</span> <span class="s1">&#39;CIRCLE </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">radius_deg</span><span class="p">)}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">publisher_ids</span> <span class="o">=</span> <span class="n">query_result</span><span class="p">[</span><span class="s1">&#39;publisherID&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s1">&#39;publisherID column missing from query_result argument&#39;</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Send datalink requests in batches of 20 publisher ids</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">20</span>

        <span class="c1"># Iterate through list of sublists to send datalink requests in batches</span>
        <span class="k">for</span> <span class="n">pid_sublist</span> <span class="ow">in</span> <span class="p">(</span><span class="n">publisher_ids</span><span class="p">[</span><span class="n">pos</span><span class="p">:</span><span class="n">pos</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span>
                            <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">publisher_ids</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">)):</span>
            <span class="n">datalink</span> <span class="o">=</span> <span class="n">pyvo</span><span class="o">.</span><span class="n">dal</span><span class="o">.</span><span class="n">adhoc</span><span class="o">.</span><span class="n">DatalinkResults</span><span class="o">.</span><span class="n">from_result_url</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">?</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_link_url</span><span class="p">,</span>
                               <span class="n">urlencode</span><span class="p">({</span><span class="s1">&#39;ID&#39;</span><span class="p">:</span> <span class="n">pid_sublist</span><span class="p">},</span> <span class="kc">True</span><span class="p">)),</span>
                <span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cadcdatalink</span><span class="o">.</span><span class="n">_session</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">service_def</span> <span class="ow">in</span> <span class="n">datalink</span><span class="o">.</span><span class="n">bysemantics</span><span class="p">(</span><span class="s1">&#39;#cutout&#39;</span><span class="p">):</span>
                <span class="n">access_url</span> <span class="o">=</span> <span class="n">service_def</span><span class="o">.</span><span class="n">access_url</span>

                <span class="k">if</span> <span class="s1">&#39;/sync&#39;</span> <span class="ow">in</span> <span class="n">access_url</span><span class="p">:</span>
                    <span class="n">service_params</span> <span class="o">=</span> <span class="n">service_def</span><span class="o">.</span><span class="n">input_params</span>
                    <span class="n">input_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">param</span><span class="o">.</span><span class="n">value</span>
                                    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">service_params</span> <span class="k">if</span>
                                    <span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="s1">&#39;RUNID&#39;</span><span class="p">]}</span>
                    <span class="n">input_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cutout_params</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">?</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">access_url</span><span class="p">,</span>
                                                 <span class="n">urlencode</span><span class="p">(</span><span class="n">input_params</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="CadcClass.get_data_urls">
<a class="viewcode-back" href="../../../api/astroquery.cadc.CadcClass.html#astroquery.cadc.CadcClass.get_data_urls">[docs]</a>
    <span class="nd">@class_or_instance</span>
    <span class="k">def</span> <span class="nf">get_data_urls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_result</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">include_auxiliaries</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to map the results of a CADC query into URLs to</span>
<span class="sd">        corresponding data that can be later downloaded.</span>

<span class="sd">        The function uses the IVOA DataLink Service</span>
<span class="sd">        (http://www.ivoa.net/documents/DataLink/) implemented at the CADC.</span>
<span class="sd">        It works directly with the results produced by `query_region` and</span>
<span class="sd">        `query_name` but in principle it can work with other query</span>
<span class="sd">        results produced with the Cadc query as long as the results</span>
<span class="sd">        contain the &#39;publisherID&#39; column. This column is part of the</span>
<span class="sd">        &#39;caom2.Plane&#39; table.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        query_result : A `~astropy.table.Table` object</span>
<span class="sd">                Result returned by `query_region` or</span>
<span class="sd">                `query_name`. In general, the result of any</span>
<span class="sd">                CADC TAP query that contains the &#39;publisherID&#39; column</span>
<span class="sd">                can be use here.</span>
<span class="sd">        include_auxiliaries : boolean</span>
<span class="sd">                ``True`` to return URLs to auxiliary files such as</span>
<span class="sd">                previews, ``False`` otherwise</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A list of URLs to data.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">query_result</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Missing metadata argument&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">publisher_ids</span> <span class="o">=</span> <span class="n">query_result</span><span class="p">[</span><span class="s1">&#39;publisherID&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s1">&#39;publisherID column missing from query_result argument&#39;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Send datalink requests in batches of 20 publisher ids</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">20</span>

        <span class="c1"># Iterate through list of sublists to send datalink requests in batches</span>
        <span class="k">for</span> <span class="n">pid_sublist</span> <span class="ow">in</span> <span class="p">(</span><span class="n">publisher_ids</span><span class="p">[</span><span class="n">pos</span><span class="p">:</span><span class="n">pos</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span>
                            <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">publisher_ids</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">)):</span>
            <span class="c1"># REQUEST=download-only is a CADC optimization to restrict</span>
            <span class="c1"># results to downloadable URLs as opposed to redirects</span>
            <span class="c1"># to other services such as cutouts that are not required</span>
            <span class="n">datalink</span> <span class="o">=</span> <span class="n">pyvo</span><span class="o">.</span><span class="n">dal</span><span class="o">.</span><span class="n">adhoc</span><span class="o">.</span><span class="n">DatalinkResults</span><span class="o">.</span><span class="n">from_result_url</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">?</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_link_url</span><span class="p">,</span>
                               <span class="n">urlencode</span><span class="p">({</span><span class="s1">&#39;ID&#39;</span><span class="p">:</span> <span class="n">pid_sublist</span><span class="p">,</span>
                                          <span class="s1">&#39;REQUEST&#39;</span><span class="p">:</span> <span class="s1">&#39;downloads-only&#39;</span><span class="p">},</span> <span class="kc">True</span><span class="p">)),</span>
                <span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cadcdatalink</span><span class="o">.</span><span class="n">_session</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">service_def</span> <span class="ow">in</span> <span class="n">datalink</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">service_def</span><span class="o">.</span><span class="n">semantics</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;http://www.opencadc.org/caom2#pkg&#39;</span><span class="p">,</span> <span class="s1">&#39;#package&#39;</span><span class="p">]:</span>
                    <span class="c1"># TODO http://www.openadc.org/caom2#pkg has been replaced</span>
                    <span class="c1"># by &quot;package&quot;. Removed it after CADC rolls out the change</span>
                    <span class="c1"># package is an alternative for downloading multiple</span>
                    <span class="c1"># data files in a tar file as an alternative to separate</span>
                    <span class="c1"># downloads. It doesn&#39;t make much sense in this case so</span>
                    <span class="c1"># filter it out.</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">include_auxiliaries</span> \
                   <span class="ow">and</span> <span class="n">service_def</span><span class="o">.</span><span class="n">semantics</span> <span class="o">!=</span> <span class="s1">&#39;#this&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">service_def</span><span class="o">.</span><span class="n">access_url</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="CadcClass.get_tables">
<a class="viewcode-back" href="../../../api/astroquery.cadc.CadcClass.html#astroquery.cadc.CadcClass.get_tables">[docs]</a>
    <span class="k">def</span> <span class="nf">get_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">only_names</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets all public tables</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        only_names : bool, optional, default False</span>
<span class="sd">            True to load table names only</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A list of table objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">table_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cadctap</span><span class="o">.</span><span class="n">tables</span>
        <span class="k">if</span> <span class="n">only_names</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">table_set</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">table_set</span><span class="o">.</span><span class="n">values</span><span class="p">())</span></div>


<div class="viewcode-block" id="CadcClass.get_table">
<a class="viewcode-back" href="../../../api/astroquery.cadc.CadcClass.html#astroquery.cadc.CadcClass.get_table">[docs]</a>
    <span class="k">def</span> <span class="nf">get_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the specified table</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        table : str, mandatory</span>
<span class="sd">            full qualified table name (i.e. schema name + table name)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A table object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tables</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">table</span> <span class="o">==</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">t</span></div>


<div class="viewcode-block" id="CadcClass.exec_sync">
<a class="viewcode-back" href="../../../api/astroquery.cadc.CadcClass.html#astroquery.cadc.CadcClass.exec_sync">[docs]</a>
    <span class="k">def</span> <span class="nf">exec_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">maxrec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">uploads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">output_format</span><span class="o">=</span><span class="s1">&#39;votable&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run a query and return the results or save them in an output_file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        query : str, mandatory</span>
<span class="sd">            SQL to execute</span>
<span class="sd">        maxrec : int</span>
<span class="sd">            the maximum records to return. defaults to the service default</span>
<span class="sd">        uploads :</span>
<span class="sd">            Temporary tables to upload and run with the queries</span>
<span class="sd">        output_file : str, Path, or file handler</span>
<span class="sd">            File to save the results to</span>
<span class="sd">        output_format :</span>
<span class="sd">            Format of the output (default is basic). Must be one</span>
<span class="sd">            of the formats supported by `astropy.table`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Results of running the query in (for now) votable format</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Support for other output formats (tsv, csv) to be added as soon</span>
<span class="sd">        as they are available in pyvo.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cadctap</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="s1">&#39;ADQL&#39;</span><span class="p">,</span>
                                       <span class="n">uploads</span><span class="o">=</span><span class="n">uploads</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">to_table</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">output_file</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">output_file</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
                <span class="c1"># Merge this case into the str once astropy is &gt;=5.1</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">):</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">output_file</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Not a valid file name, Path, or file handler&#39;</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">output_format</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="CadcClass.create_async">
<a class="viewcode-back" href="../../../api/astroquery.cadc.CadcClass.html#astroquery.cadc.CadcClass.create_async">[docs]</a>
    <span class="k">def</span> <span class="nf">create_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">maxrec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">uploads</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a TAP job to execute and returns it to the caller. The</span>
<span class="sd">        caller then can start the execution and monitor the job.</span>
<span class="sd">        Typical (no error handling) sequence of events:</span>

<span class="sd">            job = create_async(query)</span>
<span class="sd">            job = job.run().wait()</span>
<span class="sd">            job.raise_if_error()</span>
<span class="sd">            result = job.fetch_result()</span>
<span class="sd">            job.delete() # optional</span>

<span class="sd">        See ``pyvo.dal.tap`` for details about the ``AsyncTAPJob``</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        query : str, mandatory</span>
<span class="sd">            SQL to execute</span>
<span class="sd">        maxrec : int</span>
<span class="sd">            the maximum records to return. defaults to the service default</span>
<span class="sd">        uploads:</span>
<span class="sd">            Temporary tables to upload and run with the queries</span>
<span class="sd">        output_file: str or file handler:</span>
<span class="sd">            File to save the results to</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        AsyncTAPJob</span>
<span class="sd">            the query instance</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Support for other output formats (tsv, csv) to be added as soon</span>
<span class="sd">        as they are available in pyvo.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cadctap</span><span class="o">.</span><span class="n">submit_job</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="s1">&#39;ADQL&#39;</span><span class="p">,</span>
                                       <span class="n">uploads</span><span class="o">=</span><span class="n">uploads</span><span class="p">)</span></div>


<div class="viewcode-block" id="CadcClass.load_async_job">
<a class="viewcode-back" href="../../../api/astroquery.cadc.CadcClass.html#astroquery.cadc.CadcClass.load_async_job">[docs]</a>
    <span class="k">def</span> <span class="nf">load_async_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads an asynchronous job</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        jobid : str, mandatory</span>
<span class="sd">            job identifier</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A Job object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">pyvo</span><span class="o">.</span><span class="n">dal</span><span class="o">.</span><span class="n">AsyncTAPJob</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/async/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cadctap</span><span class="o">.</span><span class="n">baseurl</span><span class="p">,</span> <span class="n">jobid</span><span class="p">),</span> <span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_auth_session</span><span class="p">)</span></div>


<div class="viewcode-block" id="CadcClass.list_async_jobs">
<a class="viewcode-back" href="../../../api/astroquery.cadc.CadcClass.html#astroquery.cadc.CadcClass.list_async_jobs">[docs]</a>
    <span class="k">def</span> <span class="nf">list_async_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">phases</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">after</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">short_description</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns all the asynchronous jobs</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        phases : list of str</span>
<span class="sd">            Union of job phases to filter the results by.</span>
<span class="sd">        after : datetime</span>
<span class="sd">            Return only jobs created after this datetime</span>
<span class="sd">        last : int</span>
<span class="sd">            Return only the most recent number of jobs</span>
<span class="sd">        short_description : flag - True or False</span>
<span class="sd">            If True, the jobs in the list will contain only the information</span>
<span class="sd">            corresponding to the TAP ShortJobDescription object (job ID, phase,</span>
<span class="sd">            run ID, owner ID and creation ID) whereas if False, a separate GET</span>
<span class="sd">            call to each job is performed for the complete job description</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A list of Job objects</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cadctap</span><span class="o">.</span><span class="n">get_job_list</span><span class="p">(</span><span class="n">phases</span><span class="o">=</span><span class="n">phases</span><span class="p">,</span> <span class="n">after</span><span class="o">=</span><span class="n">after</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="n">last</span><span class="p">,</span>
                                         <span class="n">short_description</span><span class="o">=</span><span class="n">short_description</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_parse_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_args_to_payload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># convert arguments to a valid requests payload</span>
        <span class="c1"># and force the coordinates to FK5 (assuming FK5/ICRS are</span>
        <span class="c1"># interchangeable) since RA/Dec are used below</span>
        <span class="n">coordinates</span> <span class="o">=</span> <span class="n">commons</span><span class="o">.</span><span class="n">parse_coordinates</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;coordinates&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">fk5</span>
        <span class="n">radius_deg</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;radius&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="nb">format</span><span class="p">:</span> <span class="s1">&#39;VOTable&#39;</span><span class="p">}</span>
        <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="s2">&quot;SELECT * from caom2.Observation o join caom2.Plane p &quot;</span> \
            <span class="s2">&quot;ON o.obsID=p.obsID &quot;</span> \
            <span class="s2">&quot;WHERE INTERSECTS( &quot;</span> \
            <span class="s2">&quot;CIRCLE(&#39;ICRS&#39;, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">), position_bounds) = 1 AND &quot;</span> \
            <span class="s2">&quot;(quality_flag IS NULL OR quality_flag != &#39;junk&#39;)&quot;</span><span class="o">.</span>\
            <span class="nb">format</span><span class="p">(</span><span class="n">coordinates</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">radius_deg</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;collection&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">]:</span>
            <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> AND collection=&#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span>\
                <span class="nb">format</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;data_product_type&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;data_product_type&#39;</span><span class="p">]:</span>
            <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> AND dataProductType=&#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span>\
                <span class="nb">format</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;data_product_type&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">payload</span></div>



<span class="k">def</span> <span class="nf">static_vars</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">decorate</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">func</span>
    <span class="k">return</span> <span class="n">decorate</span>


<span class="nd">@static_vars</span><span class="p">(</span><span class="n">caps</span><span class="o">=</span><span class="p">{})</span>
<span class="k">def</span> <span class="nf">get_access_url</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">capability</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the URL corresponding to a service by doing a lookup in the cadc</span>
<span class="sd">    registry. It returns the access URL corresponding to cookie authentication.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    service : str</span>
<span class="sd">        the service the capability belongs to. It can be identified</span>
<span class="sd">        by a CADC uri (&#39;ivo://cadc.nrc.ca/) which is looked up in the CADC registry</span>
<span class="sd">        or by the URL where the service capabilities is found.</span>
<span class="sd">    capability : str</span>
<span class="sd">        uri representing the capability for which the access url is sought</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    The access url</span>

<span class="sd">    Note</span>
<span class="sd">    ------</span>
<span class="sd">    This function implements the functionality of a CADC registry as defined</span>
<span class="sd">    by the IVOA. It should be eventually moved to its own directory.</span>

<span class="sd">    Caching should be considered to reduce the number of remote calls to</span>
<span class="sd">    CADC registry</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">caps_url</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">service</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">capability</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">service</span>
        <span class="n">caps_url</span> <span class="o">=</span> <span class="n">service</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># get caps from the CADC registry</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">get_access_url</span><span class="o">.</span><span class="n">caps</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">CADC_REGISTRY_URL</span><span class="p">)</span>
                <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;ERROR getting the CADC registry: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                <span class="k">raise</span> <span class="n">err</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                    <span class="n">service_id</span><span class="p">,</span> <span class="n">capabilies_url</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
                    <span class="n">get_access_url</span><span class="o">.</span><span class="n">caps</span><span class="p">[</span><span class="n">service_id</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> \
                        <span class="n">capabilies_url</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="c1"># lookup the service</span>
        <span class="n">service_uri</span> <span class="o">=</span> <span class="n">service</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">service</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ivo&#39;</span><span class="p">):</span>
            <span class="c1"># assume short form of CADC service</span>
            <span class="n">service_uri</span> <span class="o">=</span> <span class="s1">&#39;ivo://cadc.nrc.ca/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">service_uri</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">get_access_url</span><span class="o">.</span><span class="n">caps</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot find the capabilities of service </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">service</span><span class="p">))</span>
        <span class="c1"># look up in the CADC reg for the service capabilities</span>
        <span class="n">caps_url</span> <span class="o">=</span> <span class="n">get_access_url</span><span class="o">.</span><span class="n">caps</span><span class="p">[</span><span class="n">service_uri</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">capability</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">caps_url</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response2</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">caps_url</span><span class="p">)</span>
        <span class="n">response2</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;ERROR getting the service capabilities: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="k">raise</span> <span class="n">e</span>

    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">response2</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="s2">&quot;html5lib&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">cap</span> <span class="ow">in</span> <span class="n">soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;capability&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;standardid&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">capability</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;interface&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cap</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;interface&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">accessurl</span><span class="o">.</span><span class="n">text</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cap</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;interface&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;securitymethod&#39;</span><span class="p">):</span>
                    <span class="n">sm</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">securitymethod</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">sm</span> <span class="ow">or</span> <span class="n">sm</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;standardid&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>\
                       <span class="n">sm</span><span class="p">[</span><span class="s1">&#39;standardid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ivo://ivoa.net/sso#cookie&quot;</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">i</span><span class="o">.</span><span class="n">accessurl</span><span class="o">.</span><span class="n">text</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;ERROR - capability </span><span class="si">{}</span><span class="s2"> not found or not working with &quot;</span>
                       <span class="s2">&quot;anonymous or cookie access&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">capability</span><span class="p">))</span>


<span class="n">Cadc</span> <span class="o">=</span> <span class="n">CadcClass</span><span class="p">()</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2025, The Astroquery Developers.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 7.4.7. &nbsp;
    Last built 01 Apr 2025. <br/>
  </p>
</footer>
  </body>
</html>